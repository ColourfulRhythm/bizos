<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>BizOS ‚Äî Your Business Operating System</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='10' y='10' width='40' height='40' rx='5' fill='%230A0A0A'/><rect x='50' y='10' width='40' height='40' rx='5' fill='%230A0A0A' opacity='0.6'/><rect x='10' y='50' width='40' height='40' rx='5' fill='%230A0A0A' opacity='0.6'/><rect x='50' y='50' width='40' height='40' rx='5' fill='%23C8963E'/></svg>"/>
<link rel="preconnect" href="https://fonts.googleapis.com"/>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<style>
  :root {
    --ink: #0A0A0A;
    --paper: #F5F0E8;
    --cream: #EDE8DC;
    --gold: #C8963E;
    --gold-light: #F0D89A;
    --muted: #7A7468;
    --line: #D8D2C4;
    --white: #FFFFFF;
    --success: #2D6A4F;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  html { scroll-behavior:smooth; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--paper);
    color: var(--ink);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ‚îÄ‚îÄ NOISE TEXTURE OVERLAY ‚îÄ‚îÄ */
  body::before {
    content:'';
    position:fixed; inset:0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events:none; z-index:0; opacity:.4;
  }

  /* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
  nav {
    position:fixed; top:0; left:0; right:0; z-index:100;
    display:flex; align-items:center; justify-content:space-between;
    padding:20px 48px;
    background: rgba(245,240,232,0.88);
    backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--line);
  }
  .logo {
    font-family: 'Instrument Serif', serif;
    font-size:22px; letter-spacing:-0.5px;
    display:flex; align-items:center; gap:10px;
  }
  .logo-mark {
    width:32px; height:32px; background:var(--ink);
    border-radius:6px; display:flex; align-items:center; justify-content:center;
  }
  .logo-mark svg { width:18px; height:18px; }
  .nav-right { display:flex; align-items:center; gap:24px; }
  .nav-link { font-size:14px; color:var(--muted); text-decoration:none; }
  .nav-link:hover { color:var(--ink); }
  .nav-cta {
    background:var(--ink); color:var(--white);
    padding:10px 22px; border-radius:8px;
    font-size:14px; font-weight:500; text-decoration:none;
    cursor:pointer; border:none;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  .nav-cta:hover { transform:translateY(-1px); box-shadow:0 4px 16px rgba(0,0,0,.2); }

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  .hero {
    min-height:100vh; display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    padding: 120px 48px 80px;
    position:relative; z-index:1;
    text-align:center;
  }
  .hero-badge {
    display:inline-flex; align-items:center; gap:8px;
    background:var(--cream); border:1px solid var(--line);
    padding:6px 14px; border-radius:100px;
    font-size:12px; font-weight:500; letter-spacing:0.5px;
    color:var(--muted); margin-bottom:32px;
    text-transform:uppercase;
  }
  .hero-badge span { width:6px; height:6px; background:var(--gold); border-radius:50%; display:inline-block; }
  h1 {
    font-family: 'Instrument Serif', serif;
    font-size: clamp(48px, 7vw, 96px);
    line-height:1.02; letter-spacing:-2px;
    max-width:900px; margin-bottom:24px;
  }
  h1 em { font-style:italic; color:var(--gold); }
  .hero-sub {
    font-size:18px; color:var(--muted); max-width:540px;
    line-height:1.7; margin-bottom:48px; font-weight:300;
  }
  .hero-actions { display:flex; align-items:center; gap:16px; flex-wrap:wrap; justify-content:center; }
  .btn-primary {
    background:var(--ink); color:var(--white);
    padding:16px 36px; border-radius:10px;
    font-size:16px; font-weight:500;
    border:none; cursor:pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    display:inline-flex; align-items:center; gap:10px;
  }
  .btn-primary:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.2); }
  .btn-secondary {
    background:transparent; color:var(--ink);
    padding:16px 28px; border-radius:10px;
    font-size:16px; border:1.5px solid var(--line);
    cursor:pointer; transition:border-color 0.15s;
  }
  .btn-secondary:hover { border-color:var(--ink); }
  .hero-proof {
    margin-top:64px; display:flex; align-items:center; gap:24px;
    font-size:13px; color:var(--muted);
  }
  .proof-divider { width:1px; height:24px; background:var(--line); }
  .proof-stat strong { color:var(--ink); font-size:18px; font-weight:600; display:block; }

  /* ‚îÄ‚îÄ HOW IT WORKS ‚îÄ‚îÄ */
  .section { padding:96px 48px; position:relative; z-index:1; }
  .section-label {
    font-size:11px; font-weight:600; letter-spacing:3px;
    text-transform:uppercase; color:var(--gold);
    margin-bottom:16px;
  }
  .section-title {
    font-family:'Instrument Serif', serif;
    font-size: clamp(32px, 4vw, 52px);
    letter-spacing:-1px; line-height:1.1;
    margin-bottom:16px;
  }
  .section-sub { font-size:16px; color:var(--muted); max-width:480px; line-height:1.7; }

  .steps-grid {
    display:grid; grid-template-columns:repeat(auto-fit, minmax(240px,1fr));
    gap:2px; margin-top:56px;
    background:var(--line); border-radius:16px; overflow:hidden;
  }
  .step {
    background:var(--paper); padding:36px 32px;
    position:relative;
  }
  .step-num {
    font-family:'Instrument Serif', serif;
    font-size:48px; color:var(--cream);
    line-height:1; margin-bottom:20px;
    font-weight:normal;
  }
  .step h3 { font-size:16px; font-weight:600; margin-bottom:10px; }
  .step p { font-size:14px; color:var(--muted); line-height:1.7; }

  /* ‚îÄ‚îÄ WHAT YOU GET ‚îÄ‚îÄ */
  .output-grid {
    display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr));
    gap:16px; margin-top:48px;
  }
  .output-card {
    background:var(--white); border:1px solid var(--line);
    border-radius:12px; padding:28px;
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .output-card:hover { transform:translateY(-3px); box-shadow:0 8px 32px rgba(0,0,0,.08); }
  .output-icon {
    width:40px; height:40px; border-radius:8px;
    display:flex; align-items:center; justify-content:center;
    margin-bottom:16px; font-size:18px;
  }
  .output-card h3 { font-size:15px; font-weight:600; margin-bottom:8px; }
  .output-card p { font-size:13px; color:var(--muted); line-height:1.6; }
  .output-tag {
    display:inline-block; font-size:11px; font-weight:500;
    padding:3px 10px; border-radius:100px; margin-top:12px;
    background:var(--cream); color:var(--muted);
  }

  /* ‚îÄ‚îÄ PRICING ‚îÄ‚îÄ */
  .pricing-box {
    max-width:520px; margin:48px auto 0;
    background:var(--ink); color:var(--white);
    border-radius:20px; padding:48px;
    text-align:center; position:relative; overflow:hidden;
  }
  .pricing-box::before {
    content:''; position:absolute; top:-60px; right:-60px;
    width:200px; height:200px; border-radius:50%;
    background: radial-gradient(circle, rgba(200,150,62,0.3) 0%, transparent 70%);
  }
  .price-label { font-size:12px; letter-spacing:2px; text-transform:uppercase; opacity:.5; margin-bottom:8px; }
  .price-amount {
    font-family:'Instrument Serif', serif;
    font-size:72px; line-height:1; letter-spacing:-2px;
    margin-bottom:4px;
  }
  .price-currency { font-size:28px; vertical-align:super; }
  .price-desc { font-size:14px; opacity:.6; margin-bottom:32px; }
  .price-features { text-align:left; margin-bottom:36px; }
  .price-features li {
    display:flex; align-items:center; gap:12px;
    font-size:14px; padding:8px 0;
    border-bottom:1px solid rgba(255,255,255,.08);
  }
  .price-features li:last-child { border-bottom:none; }
  .check-icon { color:var(--gold); font-size:16px; flex-shrink:0; }

  /* ‚îÄ‚îÄ FORM SECTION ‚îÄ‚îÄ */
  #generator { background:var(--cream); }
  .form-container {
    max-width:760px; margin:0 auto;
  }
  .form-card {
    background:var(--white); border-radius:20px;
    border:1px solid var(--line);
    overflow:hidden; margin-top:48px;
  }
  .form-header {
    background:var(--ink); padding:32px 40px;
    color:var(--white);
  }
  .form-header h2 {
    font-family:'Instrument Serif', serif;
    font-size:28px; letter-spacing:-0.5px; margin-bottom:6px;
  }
  .form-header p { font-size:14px; opacity:.6; }
  .form-body { padding:40px; }
  .form-step { display:none; }
  .form-step.active { display:block; }
  .step-indicator {
    display:flex; align-items:center; gap:8px;
    margin-bottom:32px;
  }
  .step-dot {
    width:8px; height:8px; border-radius:50%;
    background:var(--line); transition:background 0.3s;
  }
  .step-dot.done { background:var(--gold); }
  .step-dot.active { background:var(--ink); width:24px; border-radius:4px; }
  .step-title { font-size:12px; font-weight:600; letter-spacing:1px; text-transform:uppercase; color:var(--muted); margin-left:4px; }

  .form-group { margin-bottom:24px; }
  label { display:block; font-size:13px; font-weight:500; margin-bottom:8px; color:var(--ink); }
  label span { color:var(--muted); font-weight:400; }
  input[type=text], input[type=email], input[type=number], textarea, select, input[type=file] {
    width:100%; padding:13px 16px;
    border:1.5px solid var(--line); border-radius:10px;
    font-family:'DM Sans',sans-serif; font-size:15px;
    background:var(--paper); color:var(--ink);
    transition:border-color 0.2s, box-shadow 0.2s;
    outline:none;
    -webkit-appearance:none;
    appearance:none;
  }
  input[type=file] {
    padding:10px;
    cursor:pointer;
  }
  input[type=file]::file-selector-button {
    background:var(--ink); color:var(--white);
    padding:8px 16px; border-radius:6px;
    border:none; margin-right:12px;
    font-size:13px; font-weight:500; cursor:pointer;
  }
  .file-info {
    font-size:12px; color:var(--muted);
    margin-top:6px; display:none;
  }
  .file-info.show { display:block; }
  input:focus, textarea:focus, select:focus {
    border-color:var(--ink);
    box-shadow:0 0 0 3px rgba(10,10,10,.06);
    background:var(--white);
  }
  textarea { resize:vertical; min-height:100px; }
  .input-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
  .radio-group { display:grid; grid-template-columns:repeat(auto-fit, minmax(160px,1fr)); gap:10px; }
  .radio-option { position:relative; }
  .radio-option input { position:absolute; opacity:0; }
  .radio-label {
    display:block; padding:12px 16px;
    border:1.5px solid var(--line); border-radius:10px;
    font-size:14px; cursor:pointer;
    transition:all 0.15s; text-align:center;
    background:var(--paper);
  }
  .radio-option input:checked + .radio-label {
    border-color:var(--ink); background:var(--ink); color:var(--white);
  }
  /* Checkbox styling (same as radio for consistency) */
  .radio-option input[type="checkbox"]:checked + .radio-label {
    border-color:var(--ink); background:var(--ink); color:var(--white);
  }
  .form-nav {
    display:flex; justify-content:space-between;
    align-items:center; margin-top:32px;
    padding-top:24px; border-top:1px solid var(--line);
  }
  .btn-back {
    background:transparent; color:var(--muted);
    border:none; font-size:14px; cursor:pointer;
    padding:10px; display:flex; align-items:center; gap:6px;
  }
  .btn-back:hover { color:var(--ink); }
  .btn-next {
    background:var(--ink); color:var(--white);
    padding:14px 32px; border-radius:10px;
    font-size:15px; font-weight:500; border:none;
    cursor:pointer; transition:transform 0.15s;
    display:flex; align-items:center; gap:8px;
  }
  .btn-next:hover { transform:translateY(-1px); }
  .btn-next:disabled { opacity:.4; cursor:not-allowed; transform:none; }

  /* ‚îÄ‚îÄ PAYMENT STEP ‚îÄ‚îÄ */
  .payment-summary {
    background:var(--paper); border-radius:12px;
    padding:24px; margin-bottom:24px; border:1px solid var(--line);
  }
  .payment-summary h3 { font-size:15px; font-weight:600; margin-bottom:16px; }
  .summary-row {
    display:flex; justify-content:space-between;
    font-size:14px; padding:6px 0;
    border-bottom:1px solid var(--line);
    color:var(--muted);
  }
  .summary-row:last-child { border:none; font-weight:600; color:var(--ink); font-size:15px; }
  .summary-row span:last-child { color:var(--ink); }
  .paystack-btn {
    width:100%; padding:16px;
    background: linear-gradient(135deg, #00C46E, #00A85A);
    color:white; border:none; border-radius:12px;
    font-size:16px; font-weight:600; cursor:pointer;
    display:flex; align-items:center; justify-content:center; gap:10px;
    transition:transform 0.15s, box-shadow 0.15s;
  }
  .paystack-btn:hover { transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,196,110,.3); }
  .paystack-btn:disabled { opacity:.5; cursor:not-allowed; transform:none; box-shadow:none; }
  .payment-note { font-size:12px; color:var(--muted); text-align:center; margin-top:12px; }

  /* ‚îÄ‚îÄ GENERATION SCREEN ‚îÄ‚îÄ */
  #generation-screen {
    display:none; position:fixed; inset:0; z-index:1000;
    background:var(--paper);
    flex-direction:column; align-items:center; justify-content:center;
    padding:48px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    overscroll-behavior: contain; /* Prevent scroll chaining */
  }
  @media(max-width:640px) {
    #generation-screen {
      padding: 20px 16px;
      justify-content: flex-start;
      padding-top: 60px; /* Account for status bar on mobile */
    }
  }
  #generation-screen.active { display:flex; }
  .gen-logo {
    font-family:'Instrument Serif',serif; font-size:28px;
    margin-bottom:64px; opacity:.5;
  }
  .gen-title {
    font-family:'Instrument Serif',serif;
    font-size: clamp(28px, 4vw, 48px);
    letter-spacing:-1px; text-align:center;
    margin-bottom:16px;
  }
  .gen-sub { font-size:16px; color:var(--muted); text-align:center; margin-bottom:8px; line-height:1.6; }
  .gen-phase {
    font-size:14px; color:var(--ink); text-align:center;
    margin-bottom:8px; font-weight:600;
  }
  .gen-time {
    font-size:13px; color:var(--gold); text-align:center;
    margin-bottom:32px; font-weight:500; letter-spacing:0.3px;
    font-family:'DM Sans',sans-serif;
    min-height:18px;
  }
  .gen-error {
    width:100%; max-width:480px;
    background:#FEF2F2; border:1px solid #FECACA; border-radius:12px;
    padding:24px; text-align:center; margin-top:24px;
  }
  .gen-error-title { font-size:16px; font-weight:600; color:#991B1B; margin-bottom:8px; }
  .gen-error-msg { font-size:14px; color:#7F1D1D; line-height:1.5; margin-bottom:8px; }
  .gen-error-ref { font-size:12px; color:var(--muted); }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:.4} }
  .gen-pulse { animation: pulse 1.5s ease-in-out infinite; }
  .progress-track {
    width:100%; max-width:480px; height:3px;
    background:var(--line); border-radius:2px; overflow:hidden;
    margin-bottom:40px;
  }
  .progress-fill {
    height:100%; background:var(--ink);
    border-radius:2px; transition:width 0.6s ease;
    width:0%;
  }
  .gen-log {
    width:100%; max-width:480px; min-height:120px; max-height:400px;
    font-size:13px; color:var(--muted); line-height:2;
    font-family: 'DM Sans', monospace;
    overflow-y: auto; overflow-x: hidden;
    scroll-behavior: smooth;
    padding-right: 8px;
    -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
    overscroll-behavior: contain; /* Prevent scroll chaining */
  }
  @media(max-width:640px) {
    .gen-log {
      max-height: 280px; /* Smaller on mobile */
      font-size: 12px;
      padding-right: 4px;
    }
  }
  .gen-log::-webkit-scrollbar {
    width: 6px;
  }
  .gen-log::-webkit-scrollbar-track {
    background: var(--line);
    border-radius: 3px;
  }
  .gen-log::-webkit-scrollbar-thumb {
    background: var(--muted);
    border-radius: 3px;
  }
  .gen-log::-webkit-scrollbar-thumb:hover {
    background: var(--ink);
  }
  .log-line { display:flex; align-items:center; gap:10px; opacity:0; animation:fadeIn 0.4s forwards; }
  .log-line.done { color:var(--success); }
  .log-dot { width:6px; height:6px; border-radius:50%; background:currentColor; flex-shrink:0; }
  @keyframes fadeIn { to { opacity:1; } }

  /* ‚îÄ‚îÄ DOWNLOAD SCREEN ‚îÄ‚îÄ */
  #download-screen {
    display:none; position:fixed; inset:0; z-index:1000;
    background:var(--paper);
    flex-direction:column; align-items:center; justify-content:center;
    padding:48px; text-align:center;
  }
  #download-screen.active { display:flex; }
  .success-icon {
    width:80px; height:80px; border-radius:50%;
    background:var(--ink); color:var(--white);
    display:flex; align-items:center; justify-content:center;
    font-size:36px; margin-bottom:32px;
  }
  .download-title {
    font-family:'Instrument Serif',serif;
    font-size:clamp(28px,4vw,48px); letter-spacing:-1px;
    margin-bottom:12px;
  }
  .download-sub { font-size:16px; color:var(--muted); margin-bottom:40px; max-width:480px; }
  .download-stats {
    display:flex; gap:40px; margin-bottom:48px;
    justify-content:center;
  }
  .dl-stat strong { display:block; font-size:28px; font-family:'Instrument Serif',serif; }
  .dl-stat span { font-size:13px; color:var(--muted); }
  .btn-download {
    background:var(--ink); color:var(--white);
    padding:18px 48px; border-radius:12px;
    font-size:17px; font-weight:500; border:none;
    cursor:pointer; display:flex; align-items:center; gap:12px;
    transition:transform 0.15s, box-shadow 0.15s;
    margin-bottom:16px;
  }
  .btn-download:hover { transform:translateY(-2px); box-shadow:0 8px 32px rgba(0,0,0,.2); }
  .btn-restart {
    background:transparent; color:var(--muted);
    border:none; font-size:14px; cursor:pointer; padding:8px;
  }
  .btn-restart:hover { color:var(--ink); }

  /* ‚îÄ‚îÄ ERROR BANNER ‚îÄ‚îÄ */
  .error-banner {
    background:#FEE2E2; border:1px solid #FECACA;
    border-radius:10px; padding:14px 18px;
    font-size:14px; color:#991B1B; margin-bottom:20px;
    display:none;
  }
  .error-banner.show { display:block; }

  /* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
  footer {
    padding:40px 48px; border-top:1px solid var(--line);
    display:flex; justify-content:space-between; align-items:center;
    position:relative; z-index:1; font-size:13px; color:var(--muted);
  }

  @media(max-width:640px) {
    nav { padding:16px 20px; }
    .hero, .section { padding-left:20px; padding-right:20px; }
    .input-row { grid-template-columns:1fr; }
    .form-body { padding:24px 20px; }
    .form-header { padding:24px 20px; }
    .pricing-box { padding:32px 24px; }
    .hero-proof { flex-direction:column; gap:12px; }
    footer { flex-direction:column; gap:12px; text-align:center; }
    .download-stats { gap:24px; }
  }
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="logo">
    <div class="logo-mark">
      <svg viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect x="2" y="2" width="6" height="6" rx="1" fill="white"/>
        <rect x="10" y="2" width="6" height="6" rx="1" fill="white" opacity=".6"/>
        <rect x="2" y="10" width="6" height="6" rx="1" fill="white" opacity=".6"/>
        <rect x="10" y="10" width="6" height="6" rx="1" fill="#C8963E"/>
      </svg>
    </div>
    BizOS
  </div>
  <div class="nav-right">
    <a href="#how-it-works" class="nav-link">How it works</a>
    <a href="#what-you-get" class="nav-link">What you get</a>
    <button class="nav-cta" onclick="scrollToGenerator()">Build my system ‚Üí</button>
  </div>
</nav>

<!-- HERO -->
<section class="hero">
  <div class="hero-badge"><span></span> AI-Powered Business Systems</div>
  <h1>Your entire business,<br/><em>systematized</em> in minutes.</h1>
  <p class="hero-sub">Transform your business from chaos to a scalable, automated system. Get a complete operating system ‚Äî strategic frameworks, SOPs, sales systems, automation guides ‚Äî that boosts revenue and increases customer retention by 70%+.</p>
  <div class="hero-actions">
    <button class="btn-primary" onclick="scrollToGenerator()">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M9 2v14M2 9h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
      Build my system
    </button>
    <button class="btn-secondary" onclick="document.getElementById('how-it-works').scrollIntoView({behavior:'smooth'})">See how it works</button>
  </div>
  <div class="hero-proof">
    <div class="proof-stat"><strong>5 min</strong>Setup to download</div>
    <div class="proof-divider"></div>
    <div class="proof-stat"><strong>24-30</strong>Strategic documents</div>
    <div class="proof-divider"></div>
    <div class="proof-stat"><strong>Any</strong>Business type</div>
  </div>
</section>

<!-- HOW IT WORKS -->
<section class="section" id="how-it-works" style="background:var(--cream);">
  <div class="section-label">Process</div>
  <div class="section-title">From chaos to<br/>scalable system</div>
  <p class="section-sub">Four steps. Five minutes. A complete business operating system that transforms operations, boosts revenue, and increases customer retention by 70%+.</p>
  <div class="steps-grid">
    <div class="step">
      <div class="step-num">01</div>
      <h3>Describe your business</h3>
      <p>Tell us what you do, how you sell, how you deliver, and who you serve. Takes about 3 minutes.</p>
    </div>
    <div class="step">
      <div class="step-num">02</div>
      <h3>Pay once</h3>
      <p>A one-time fee per generation. No subscription. No hidden costs. Pay, and your transformation system is built.</p>
    </div>
    <div class="step">
      <div class="step-num">03</div>
      <h3>AI builds your system</h3>
      <p>Claude creates a complete strategic operating system with frameworks, automation guides, and revenue-boosting systems ‚Äî tailored to your business.</p>
    </div>
    <div class="step">
      <div class="step-num">04</div>
      <h3>Transform your business</h3>
      <p>Download your complete system. Implement the frameworks. Watch revenue grow and customer retention increase by 70%+.</p>
    </div>
  </div>
</section>

<!-- WHAT YOU GET -->
<section class="section" id="what-you-get">
  <div class="section-label">Deliverables</div>
  <div class="section-title">Everything a real<br/>business needs</div>
  <p class="section-sub">Strategic frameworks that boost revenue and increase customer retention by 70%+. Tailored to your specific business ‚Äî not copy-paste templates. Every system uses your language, your process, your brand.</p>
  <div class="output-grid">
    <div class="output-card">
      <div class="output-icon" style="background:#EAF0F6;">üìã</div>
      <h3>Company Profile & Strategy</h3>
      <p>Strategic foundation ‚Äî mission, vision, values, competitive positioning, and growth frameworks.</p>
      <span class="output-tag">3‚Äì4 documents</span>
    </div>
    <div class="output-card">
      <div class="output-icon" style="background:#E8F5EE;">üîÑ</div>
      <h3>Client Experience System</h3>
      <p>Complete onboarding flows, journey mapping, and retention strategies that increase customer retention by 70%+.</p>
      <span class="output-tag">3‚Äì4 documents</span>
    </div>
    <div class="output-card">
      <div class="output-icon" style="background:#FFF9EC;">üìÑ</div>
      <h3>Document Templates & Legal</h3>
      <p>Complete legal framework ‚Äî service agreements, proposals with pricing strategy, client communications, and compliance templates.</p>
      <span class="output-tag">4‚Äì5 documents</span>
    </div>
    <div class="output-card">
      <div class="output-icon" style="background:#FEF3C7;">üí¨</div>
      <h3>Sales & Revenue System</h3>
      <p>Complete sales methodology, discovery frameworks, closing systems, and pipeline management that boost revenue.</p>
      <span class="output-tag">4‚Äì5 documents</span>
    </div>
    <div class="output-card">
      <div class="output-icon" style="background:#FDE8E8;">üì£</div>
      <h3>Marketing & Growth Engine</h3>
      <p>Brand messaging frameworks, content strategies, growth systems, and referral programs that drive retention.</p>
      <span class="output-tag">4‚Äì5 documents</span>
    </div>
    <div class="output-card">
      <div class="output-icon" style="background:#F3E8FF;">‚öôÔ∏è</div>
      <h3>Operations & Scalability</h3>
      <p>Complete SOP library, workflow automation guides, quality systems, and scalability roadmaps for growth.</p>
      <span class="output-tag">4‚Äì5 documents</span>
    </div>
    <div class="output-card">
      <div class="output-icon" style="background:#E0F2FE;">üí∞</div>
      <h3>Finance & Business Intelligence</h3>
      <p>Financial management systems, forecasting frameworks, pricing strategies, and business intelligence dashboards.</p>
      <span class="output-tag">4‚Äì5 documents</span>
    </div>
  </div>
</section>

<!-- PRICING -->
<section class="section" style="background:var(--cream);" id="pricing">
  <div style="text-align:center;">
    <div class="section-label" style="text-align:center;">Pricing</div>
    <div class="section-title">Choose your plan.<br/>Pay once, own forever.</div>
    <p class="section-sub" style="margin:0 auto 0;">No subscriptions. No upsells. Professional business documentation tailored to your needs.</p>
  </div>
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(300px, 1fr));gap:32px;max-width:1000px;margin:0 auto;">
    <!-- Business Plan Only -->
    <div class="pricing-box" style="position:relative;">
      <div style="position:absolute;top:16px;right:16px;background:var(--gold);color:var(--ink);padding:4px 12px;border-radius:100px;font-size:11px;font-weight:600;letter-spacing:0.5px;">POPULAR</div>
      <div class="price-label">Business Plan Only</div>
      <div style="margin-bottom:12px;">
        <div class="price-amount" style="margin-bottom:0;"><span class="price-currency">‚Ç¶</span>5,000</div>
        <div class="price-desc">~$3.50 USD ¬∑ One-time payment</div>
      </div>
      <ul class="price-features" style="list-style:none;text-align:left;">
        <li><span class="check-icon">‚ú¶</span> One-page comprehensive business plan</li>
        <li><span class="check-icon">‚ú¶</span> 9 strategic sections included</li>
        <li><span class="check-icon">‚ú¶</span> Investor-ready format</li>
        <li><span class="check-icon">‚ú¶</span> Immediate download</li>
        <li><span class="check-icon">‚ú¶</span> Tailored to your business</li>
        <li><span class="check-icon">‚ú¶</span> Editable & brandable</li>
      </ul>
      <button class="btn-primary" style="width:100%;justify-content:center;font-size:16px;margin-top:24px;" onclick="selectProduct('BUSINESS_PLAN'); scrollToGenerator();">
        Get Business Plan ‚Üí
      </button>
    </div>
    
    <!-- Full System -->
    <div class="pricing-box" style="border:2px solid var(--gold);position:relative;">
      <div style="position:absolute;top:16px;right:16px;background:var(--ink);color:var(--white);padding:4px 12px;border-radius:100px;font-size:11px;font-weight:600;letter-spacing:0.5px;">BEST VALUE</div>
      <div class="price-label">Full Business System</div>
      <div style="margin-bottom:12px;">
        <div style="font-size:14px;color:var(--muted);text-decoration:line-through;margin-bottom:4px;">Market Value: $200 USD</div>
        <div class="price-amount" style="margin-bottom:0;"><span class="price-currency">‚Ç¶</span>15,000</div>
        <div class="price-desc">~$10 USD ¬∑ One-time payment</div>
      </div>
      <div style="margin:16px 0;padding:16px;background:linear-gradient(135deg, rgba(200,150,62,0.15) 0%, rgba(200,150,62,0.08) 100%);border-radius:10px;border:2px solid var(--gold);text-align:center;">
        <div style="font-size:18px;font-weight:700;color:var(--ink);margin-bottom:6px;">Worth $200 USD</div>
        <div style="font-size:13px;color:var(--gold);font-weight:600;letter-spacing:0.5px;">You Save 92% ‚Ä¢ Professional Documentation</div>
      </div>
      <ul class="price-features" style="list-style:none;text-align:left;">
        <li><span class="check-icon">‚ú¶</span> Full AI-generated business system</li>
        <li><span class="check-icon">‚ú¶</span> 24‚Äì30 strategic business documents</li>
        <li><span class="check-icon">‚ú¶</span> Organised folder structure</li>
        <li><span class="check-icon">‚ú¶</span> Immediate ZIP download</li>
        <li><span class="check-icon">‚ú¶</span> Tailored to your specific business</li>
        <li><span class="check-icon">‚ú¶</span> Editable & brandable</li>
      </ul>
      <button class="btn-primary" style="width:100%;justify-content:center;font-size:16px;margin-top:24px;" onclick="selectProduct('FULL_SYSTEM'); scrollToGenerator();">
        Build my system now ‚Üí
      </button>
    </div>
  </div>
</section>

<!-- GENERATOR -->
<section class="section" id="generator">
  <div class="section-label">Generator</div>
  <div class="section-title">Build your system</div>
  <p class="section-sub">Answer a few questions about your business and we'll generate everything.</p>

  <div class="form-container">
    <div class="form-card">
      <div class="form-header">
        <h2>Business Profile</h2>
        <p>This takes about 3‚Äì4 minutes. The more detail you give, the better your documents.</p>
      </div>
      <div class="form-body">

        <div class="error-banner" id="error-banner"></div>

        <!-- STEP 1: BASICS -->
        <div class="form-step active" id="step-1">
          <div class="step-indicator">
            <div class="step-dot active" id="dot-1"></div>
            <div class="step-dot" id="dot-2"></div>
            <div class="step-dot" id="dot-3"></div>
            <div class="step-dot" id="dot-4"></div>
            <div class="step-dot" id="dot-5"></div>
            <span class="step-title">Business Basics</span>
          </div>
          <div class="form-group">
            <label>Business Name <span>*</span></label>
            <input type="text" id="biz-name" placeholder="e.g. Focal Point Property Development" />
          </div>
          <div class="form-group">
            <label>Industry / Sector <span>*</span></label>
            <select id="biz-industry">
              <option value="">Select your industry...</option>
              <option>Real Estate & Property</option>
              <option>Construction & Engineering</option>
              <option>Retail & E-commerce</option>
              <option>Food & Beverage / Restaurant</option>
              <option>Healthcare & Wellness</option>
              <option>Education & Training</option>
              <option>Financial Services</option>
              <option>Logistics & Delivery</option>
              <option>Technology / SaaS</option>
              <option>Creative & Media Agency</option>
              <option>Legal & Professional Services</option>
              <option>Beauty & Personal Care</option>
              <option>Events & Hospitality</option>
              <option>Agriculture & Agritech</option>
              <option>Manufacturing</option>
              <option>Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>What does your business do? <span>* (be specific)</span></label>
            <textarea id="biz-description" placeholder="e.g. We develop and sell residential plots and estates in Abuja, using a flexible instalment model. Our focus is on lifestyle-designed communities for middle-income families."></textarea>
          </div>
          <div class="form-group">
            <label>Upload Business Document/Notes <span>(optional)</span></label>
            <input type="file" id="biz-document" accept=".pdf,.doc,.docx,.txt,.md" onchange="handleFileUpload(event)" />
            <div class="file-info" id="file-info"></div>
            <p style="font-size:11px; color:var(--muted); margin-top:6px;">Upload any existing business docs, notes, or descriptions. We'll use this to better understand your business.</p>
          </div>
          <div class="input-row">
            <div class="form-group">
              <label>Country of Operation</label>
              <input type="text" id="biz-country" placeholder="e.g. Nigeria" />
            </div>
            <div class="form-group">
              <label>City / Region</label>
              <input type="text" id="biz-city" placeholder="e.g. Lagos" />
            </div>
          </div>
          <div class="form-nav">
            <div></div>
            <button class="btn-next" onclick="nextStep(1)">Continue <span>‚Üí</span></button>
          </div>
        </div>

        <!-- STEP 2: OPERATIONS -->
        <div class="form-step" id="step-2">
          <div class="step-indicator">
            <div class="step-dot done" id="dot-1b"></div>
            <div class="step-dot active" id="dot-2b"></div>
            <div class="step-dot" id="dot-3b"></div>
            <div class="step-dot" id="dot-4b"></div>
            <div class="step-dot" id="dot-5b"></div>
            <span class="step-title">How You Work</span>
          </div>
          <div class="form-group">
            <label>How do you get clients? <span>*</span></label>
            <div class="radio-group">
              <div class="radio-option"><input type="radio" name="sales-channel" id="sc1" value="Direct sales team"/><label class="radio-label" for="sc1">Sales team</label></div>
              <div class="radio-option"><input type="radio" name="sales-channel" id="sc2" value="Online / social media"/><label class="radio-label" for="sc2">Social media</label></div>
              <div class="radio-option"><input type="radio" name="sales-channel" id="sc3" value="Referrals & word of mouth"/><label class="radio-label" for="sc3">Referrals</label></div>
              <div class="radio-option"><input type="radio" name="sales-channel" id="sc4" value="Walk-in / storefront"/><label class="radio-label" for="sc4">Walk-in</label></div>
              <div class="radio-option"><input type="radio" name="sales-channel" id="sc5" value="Online marketplace / platform"/><label class="radio-label" for="sc5">Marketplace</label></div>
              <div class="radio-option"><input type="radio" name="sales-channel" id="sc6" value="Multiple channels"/><label class="radio-label" for="sc6">Mixed</label></div>
            </div>
          </div>
          <div class="form-group">
            <label>How do you deliver your product/service? <span>*</span></label>
            <textarea id="biz-delivery" placeholder="e.g. Clients visit our showroom, then we guide them through the plot selection and payment process. We have a 3-step onboarding flow after initial payment."></textarea>
          </div>
          <div class="form-group">
            <label>How do clients pay you? <span>(select all that apply)</span></label>
            <div class="radio-group">
              <div class="radio-option"><input type="checkbox" name="pay-model" id="pm1" value="Full payment upfront"/><label class="radio-label" for="pm1">Upfront</label></div>
              <div class="radio-option"><input type="checkbox" name="pay-model" id="pm2" value="Instalment / payment plan"/><label class="radio-label" for="pm2">Instalments</label></div>
              <div class="radio-option"><input type="checkbox" name="pay-model" id="pm3" value="Monthly subscription"/><label class="radio-label" for="pm3">Subscription</label></div>
              <div class="radio-option"><input type="checkbox" name="pay-model" id="pm4" value="Invoice on delivery"/><label class="radio-label" for="pm4">Invoice</label></div>
            </div>
          </div>
          <div class="form-group">
            <label>Business size</label>
            <div class="radio-group">
              <div class="radio-option"><input type="radio" name="biz-size" id="bs1" value="Solo (just me)"/><label class="radio-label" for="bs1">Solo</label></div>
              <div class="radio-option"><input type="radio" name="biz-size" id="bs2" value="Small team (2‚Äì10)"/><label class="radio-label" for="bs2">2‚Äì10 people</label></div>
              <div class="radio-option"><input type="radio" name="biz-size" id="bs3" value="Medium (11‚Äì50)"/><label class="radio-label" for="bs3">11‚Äì50 people</label></div>
              <div class="radio-option"><input type="radio" name="biz-size" id="bs4" value="Growing (50+)"/><label class="radio-label" for="bs4">50+ people</label></div>
            </div>
          </div>
          <div class="form-nav">
            <button class="btn-back" onclick="prevStep(2)">‚Üê Back</button>
            <button class="btn-next" onclick="nextStep(2)">Continue <span>‚Üí</span></button>
          </div>
        </div>

        <!-- STEP 3: DOCUMENTS & BRAND -->
        <div class="form-step" id="step-3">
          <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <div class="step-dot"></div>
            <span class="step-title">Brand & Documents</span>
          </div>
          <div class="form-group">
            <label>Who is your typical customer? <span>*</span></label>
            <textarea id="biz-customer" placeholder="e.g. Middle-income professionals aged 28‚Äì45 in Abuja, looking for a first home or investment. Many are diaspora or Lagos-based with Abuja ambitions." style="min-height:80px;"></textarea>
          </div>
          <div class="form-group">
            <label>What documents do you currently use? <span>(or wish you had)</span></label>
            <textarea id="biz-docs" placeholder="e.g. We currently have a proposal template but nothing else. We need client agreements, receipts, onboarding letters, and a proper sales process document." style="min-height:80px;"></textarea>
          </div>
          <div class="form-group">
            <label>Any specific services, products, or projects to include?</label>
            <input type="text" id="biz-products" placeholder="e.g. Project Alpha (luxury homes), Project Beta (affordable plots), Maintenance Service" />
          </div>
          <div class="form-group">
            <label>Your brand tone / personality</label>
            <div class="radio-group">
              <div class="radio-option"><input type="radio" name="brand-tone" id="bt1" value="Professional & formal"/><label class="radio-label" for="bt1">Professional</label></div>
              <div class="radio-option"><input type="radio" name="brand-tone" id="bt2" value="Warm & approachable"/><label class="radio-label" for="bt2">Warm</label></div>
              <div class="radio-option"><input type="radio" name="brand-tone" id="bt3" value="Bold & aspirational"/><label class="radio-label" for="bt3">Bold</label></div>
              <div class="radio-option"><input type="radio" name="brand-tone" id="bt4" value="Technical & expert"/><label class="radio-label" for="bt4">Technical</label></div>
            </div>
          </div>
          <div class="form-nav">
            <button class="btn-back" onclick="prevStep(3)">‚Üê Back</button>
            <button class="btn-next" onclick="nextStep(3)">Continue <span>‚Üí</span></button>
          </div>
        </div>

        <!-- STEP 4: PREVIEW -->
        <div class="form-step" id="step-4">
          <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <div class="step-dot"></div>
            <span class="step-title">Preview</span>
          </div>

          <div style="background:var(--cream); border-radius:12px; padding:24px; margin-bottom:24px; border:1px solid var(--line);">
            <h3 style="font-size:18px; margin-bottom:16px; font-family:'Instrument Serif',serif;">What You'll Get</h3>
            <p style="font-size:14px; color:var(--muted); margin-bottom:20px; line-height:1.6;">Based on your business profile, we'll generate a complete operating system tailored specifically to <strong id="preview-biz-name"></strong>.</p>
            
            <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px,1fr)); gap:12px; margin-bottom:20px;">
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">üìã</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Company Profile</div>
                <div style="font-size:11px; color:var(--muted);">Mission, vision, services</div>
              </div>
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">üîÑ</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Onboarding Flows</div>
                <div style="font-size:11px; color:var(--muted);">Client process docs</div>
              </div>
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">üìÑ</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Templates</div>
                <div style="font-size:11px; color:var(--muted);">Agreements, letters</div>
              </div>
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">üí¨</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Sales Kit</div>
                <div style="font-size:11px; color:var(--muted);">Scripts & objections</div>
              </div>
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">üì£</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Marketing Kit</div>
                <div style="font-size:11px; color:var(--muted);">Messaging & campaigns</div>
              </div>
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">‚öôÔ∏è</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">SOPs</div>
                <div style="font-size:11px; color:var(--muted);">Operations & processes</div>
              </div>
              <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--line);">
                <div style="font-size:24px; margin-bottom:8px;">üí∞</div>
                <div style="font-size:13px; font-weight:600; margin-bottom:4px;">Finance</div>
                <div style="font-size:11px; color:var(--muted);">Budget, expenses, reporting</div>
              </div>
            </div>

            <div style="background:var(--white); padding:16px; border-radius:8px; border:1px solid var(--gold);">
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
                <span style="color:var(--gold); font-size:20px;">‚ú®</span>
                <strong style="font-size:14px;">24‚Äì30 Strategic Business Documents</strong>
              </div>
              <p style="font-size:12px; color:var(--muted); line-height:1.5;">Complete business transformation system tailored to your specific business: <span id="preview-industry"></span>. Includes strategic frameworks, operational systems, automation guides, scalability roadmaps, and complete financial intelligence. This is not just templates‚Äîit's a premium business operating system.</p>
            </div>
          </div>

          <div class="form-nav">
            <button class="btn-back" onclick="prevStep(4)">‚Üê Back</button>
            <button class="btn-next" onclick="nextStep(4)">Continue to Payment <span>‚Üí</span></button>
          </div>
        </div>

        <!-- STEP 5: PAYMENT -->
        <div class="form-step" id="step-5">
          <div class="step-indicator">
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot done"></div>
            <div class="step-dot active"></div>
            <span class="step-title">Payment</span>
          </div>

          <div class="payment-summary">
            <h3>Order Summary</h3>
            <div id="order-summary-content">
              <!-- Will be populated by updateOrderSummary() -->
              <div class="summary-row" style="margin-bottom:8px;" id="market-value-row"><span style="font-size:13px;color:var(--muted);text-decoration:line-through;">Market Value: $200 USD</span><span style="font-size:13px;color:var(--gold);font-weight:600;">92% OFF</span></div>
              <div class="summary-row"><span id="product-name">Business System Generation</span><span id="product-price">‚Ç¶15,000</span></div>
              <div class="summary-row" id="features-row"><span>Strategic Documents (24‚Äì30 files)</span><span>Included</span></div>
              <div class="summary-row"><span>ZIP download</span><span>Included</span></div>
              <div class="summary-row"><span><strong>Total</strong></span><span><strong id="total-price">‚Ç¶15,000</strong></span></div>
            </div>
          </div>

          <div class="form-group">
            <label>Your Email <span>(for receipt)</span></label>
            <input type="email" id="user-email" placeholder="you@example.com" />
          </div>
          <div class="form-group">
            <label>Your Name</label>
            <input type="text" id="user-name" placeholder="Full name" />
          </div>

          <button class="paystack-btn" id="pay-btn" onclick="initPayment()">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg>
            Pay <span id="price-display">‚Ç¶15,000</span> with Paystack
          </button>
          <div class="payment-note">üîí Secured by Paystack ¬∑ Generation starts immediately after payment</div>
          <div id="value-messaging-box" style="margin-top:16px;padding:16px;background:linear-gradient(135deg, rgba(200,150,62,0.15) 0%, rgba(200,150,62,0.08) 100%);border-radius:10px;border:2px solid var(--gold);text-align:center;">
            <div style="font-size:20px;font-weight:700;color:var(--ink);margin-bottom:6px;">Worth $200 USD</div>
            <div style="font-size:13px;color:var(--gold);font-weight:600;letter-spacing:0.5px;">You Save 92% ‚Ä¢ Professional Documentation</div>
          </div>

          <div class="form-nav">
            <button class="btn-back" onclick="prevStep(5)">‚Üê Back</button>
          </div>
        </div>

      </div>
    </div>
  </div>
</section>

<footer>
  <div>¬© 2026 BizOS ¬∑ Powered by Claude AI</div>
  <div style="display:flex;gap:24px;">
    <a href="#" style="color:var(--muted);text-decoration:none;">Privacy</a>
    <a href="#" style="color:var(--muted);text-decoration:none;">Terms</a>
    <a href="#" style="color:var(--muted);text-decoration:none;">Support</a>
  </div>
</footer>

<!-- GENERATION SCREEN -->
<div id="generation-screen">
  <div class="gen-logo">BizOS</div>
  <div class="gen-title" id="gen-title">Building your system‚Ä¶</div>
  <div class="gen-sub" id="gen-sub">Your payment was successful. Generating your complete business operating system now.</div>
  <div class="gen-phase" id="gen-phase">Step 1 of 8 ‚Äî Planning document structure</div>
  <div class="gen-time" id="gen-time"></div>
  <div class="progress-track"><div class="progress-fill" id="progress-fill"></div></div>
  <div class="gen-log" id="gen-log"></div>
  <div id="folder-downloads" style="margin-top:24px;padding:20px;background:var(--cream);border-radius:12px;display:none;">
    <div style="font-weight:600;margin-bottom:16px;color:var(--ink);">üì¶ Download Completed Folders</div>
    <div id="folder-download-list" style="display:flex;flex-direction:column;gap:12px;"></div>
  </div>
  <div class="gen-error" id="gen-error" style="display:none;">
    <div class="gen-error-title">Generation encountered an issue</div>
    <div class="gen-error-msg" id="gen-error-msg"></div>
    <div class="gen-error-ref" id="gen-error-ref"></div>
    <button class="btn-primary" id="gen-retry-btn" onclick="retryGeneration()" style="margin-top:16px;">Try Again</button>
  </div>
</div>

<!-- DOWNLOAD SCREEN -->
<div id="download-screen">
  <div class="gen-logo">BizOS</div>
  <div class="success-icon">‚úì</div>
  <div class="download-title">Your system is ready.</div>
  <div class="download-sub" id="download-sub">Your complete business operating system has been generated and packaged.</div>
  <div class="download-stats">
    <div class="dl-stat"><strong id="dl-doc-count">0</strong><span>Documents</span></div>
    <div class="dl-stat"><strong id="dl-folder-count">0</strong><span>Folders</span></div>
  </div>
  <button class="btn-download" id="download-btn">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2v11M5 9l5 6 5-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 17h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
    Download ZIP
  </button>
  <button class="btn-restart" onclick="location.reload()">Generate another business ‚Üí</button>
</div>

<script>
// Load Paystack script with error handling
(function() {
  let paystackLoaded = false;
  let retryCount = 0;
  const maxRetries = 3;
  
  function loadPaystack() {
    const script = document.createElement('script');
    script.src = 'https://js.paystack.co/v1/inline.js';
    script.async = true;
    
    script.onload = function() {
      paystackLoaded = true;
      console.log('Paystack script loaded successfully');
      // Wait a bit for PaystackPop to be available (sometimes it's not immediately available)
      let checkCount = 0;
      const checkInterval = setInterval(() => {
        checkCount++;
        if (typeof PaystackPop !== 'undefined') {
          window.paystackReady = true;
          console.log('PaystackPop is ready');
          clearInterval(checkInterval);
        } else if (checkCount >= 10) {
          // After 1 second (10 * 100ms), give up
          console.warn('Paystack script loaded but PaystackPop not available after 1 second');
          window.paystackReady = false;
          clearInterval(checkInterval);
        }
      }, 100);
    };
    
    script.onerror = function() {
      console.error('Failed to load Paystack script');
      retryCount++;
      
      if (retryCount < maxRetries) {
        console.log(`Retrying Paystack script load (attempt ${retryCount + 1}/${maxRetries})...`);
        setTimeout(loadPaystack, 2000 * retryCount); // Exponential backoff
      } else {
        console.error('Paystack script failed to load after ' + maxRetries + ' attempts');
        window.paystackReady = false;
        window.paystackLoadError = true;
        
        // Show user-friendly error
        if (document.readyState === 'complete') {
          showPaystackError();
        } else {
          window.addEventListener('load', showPaystackError);
        }
      }
    };
    
    document.head.appendChild(script);
  }
  
  function showPaystackError() {
    // Only show if user is on payment step
    const payBtn = document.getElementById('pay-btn');
    if (payBtn && !paystackLoaded) {
      payBtn.disabled = true;
      payBtn.innerHTML = '‚ö†Ô∏è Payment system unavailable - Please refresh';
      payBtn.style.background = 'var(--muted)';
      
      // Show error message
      const errorMsg = document.createElement('div');
      errorMsg.style.cssText = 'margin-top:12px;padding:12px;background:#fee;border:1px solid #fcc;border-radius:8px;color:#c33;font-size:14px;';
      errorMsg.innerHTML = '‚ö†Ô∏è <strong>Payment system unavailable</strong><br>Unable to load Paystack. Please:<br>1. Check your internet connection<br>2. Refresh the page<br>3. Try again in a moment';
      
      const paymentNote = document.querySelector('.payment-note');
      if (paymentNote && !paymentNote.nextElementSibling?.classList.contains('paystack-error')) {
        errorMsg.className = 'paystack-error';
        paymentNote.parentNode.insertBefore(errorMsg, paymentNote.nextSibling);
      }
    }
  }
  
  // Start loading
  loadPaystack();
})();
</script>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONFIGURATION - Update these values with your credentials
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const CONFIG = {
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // BACKEND CONFIGURATION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // Choose your backend: 'vercel' or 'supabase'
  BACKEND_TYPE: 'supabase', // Using Supabase Edge Functions for 300s timeout
  
  // Supabase Configuration (if BACKEND_TYPE === 'supabase')
  SUPABASE_URL: 'https://nxygpqnbkoxfdwtvsufw.supabase.co/functions/v1', // Your Supabase project URL
  SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im54eWdwcW5ia294ZmR3dHZzdWZ3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE1NDM2NzEsImV4cCI6MjA4NzExOTY3MX0.NwAVoCoegtF_RCU2kMmBkNU9bmjMTBeqeanh4utapQk', // Supabase anon public key
  
  // Vercel Configuration (if BACKEND_TYPE === 'vercel')
  // Auto-detects based on current domain
  BACKEND_URL: (() => {
    const isLocal = window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1' ||
                    window.location.hostname.startsWith('192.168.') ||
                    window.location.hostname.startsWith('10.');
    return isLocal ? 'http://localhost:3001' : window.location.origin;
  })(),
  
  // Get your Paystack public key from: https://dashboard.paystack.com/#/settings/developer
  // Test key format: pk_test_xxxxxxxxxxxxx
  // Live key format: pk_live_xxxxxxxxxxxxx
  PAYSTACK_PUBLIC_KEY: 'pk_live_65167bc2839df9c0dc11ca91e608ce2635abf44b', // Live key - Production
  
  // Product types
  PRODUCT_TYPES: {
    FULL_SYSTEM: {
      name: 'Full Business System',
      priceKobo: 1500000,
      priceDisplay: '‚Ç¶15,000',
      description: 'Complete business transformation system (24-30 documents)'
    },
    BUSINESS_PLAN: {
      name: 'Business Plan Only',
      priceKobo: 500000,
      priceDisplay: '‚Ç¶5,000',
      description: 'One-page comprehensive business plan'
    }
  },
  // Default to full system
  SELECTED_PRODUCT: 'FULL_SYSTEM',
  
  // Legacy support - defaults to full system
  PRICE_KOBO: 1500000,
  PRICE_DISPLAY: '‚Ç¶15,000'
};

// ‚îÄ‚îÄ‚îÄ GLOBALS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentStep = 1;
let generatedZip = null;
let bizData = {};
let uploadedFile = null;
let uploadedFileContent = null;
const FORM_SAVE_KEY = 'bizos_form_data';
let formSaveTimeout = null;
let selectedProductType = 'FULL_SYSTEM'; // 'FULL_SYSTEM' or 'BUSINESS_PLAN'

// ‚îÄ‚îÄ‚îÄ PRODUCT SELECTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selectProduct(productType) {
  selectedProductType = productType;
  CONFIG.SELECTED_PRODUCT = productType;
  
  // Update price display
  const product = CONFIG.PRODUCT_TYPES[productType];
  CONFIG.PRICE_KOBO = product.priceKobo;
  CONFIG.PRICE_DISPLAY = product.priceDisplay;
  
  // Update price display in UI if payment step is visible
  const priceDisplay = document.getElementById('price-display');
  if (priceDisplay) {
    priceDisplay.textContent = product.priceDisplay;
  }
  
  // Update order summary if visible
  updateOrderSummary();
  
  console.log('Product selected:', productType, product);
}

function updateOrderSummary() {
  const product = CONFIG.PRODUCT_TYPES[selectedProductType];
  
  // Update product name
  const productNameEl = document.getElementById('product-name');
  if (productNameEl) productNameEl.textContent = product.name;
  
  // Update product price
  const productPriceEl = document.getElementById('product-price');
  if (productPriceEl) productPriceEl.textContent = product.priceDisplay;
  
  // Update total
  const totalPriceEl = document.getElementById('total-price');
  if (totalPriceEl) totalPriceEl.textContent = product.priceDisplay;
  
  // Update features row based on product type
  const featuresRow = document.getElementById('features-row');
  if (featuresRow) {
    if (selectedProductType === 'BUSINESS_PLAN') {
      featuresRow.innerHTML = '<span>9 Strategic Sections</span><span>Included</span>';
    } else {
      featuresRow.innerHTML = '<span>Strategic Documents (24‚Äì30 files)</span><span>Included</span>';
    }
  }
  
  // Show/hide market value row (only for full system)
  const marketValueRow = document.getElementById('market-value-row');
  if (marketValueRow) {
    marketValueRow.style.display = selectedProductType === 'FULL_SYSTEM' ? 'flex' : 'none';
  }
  
  // Show/hide value messaging box (only for full system)
  const valueMessagingBox = document.getElementById('value-messaging-box');
  if (valueMessagingBox) {
    valueMessagingBox.style.display = selectedProductType === 'FULL_SYSTEM' ? 'block' : 'none';
  }
  
  // Update price display in button
  const priceDisplay = document.getElementById('price-display');
  if (priceDisplay) priceDisplay.textContent = product.priceDisplay;
}

// ‚îÄ‚îÄ‚îÄ FORM AUTO-SAVE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function saveFormData() {
  try {
    const formData = collectData();
    // Also save current step
    formData._currentStep = currentStep;
    localStorage.setItem(FORM_SAVE_KEY, JSON.stringify({
      ...formData,
      _timestamp: Date.now()
    }));
    console.log('Form data auto-saved');
  } catch(e) {
    console.warn('Could not save form data:', e);
  }
}

function restoreFormData() {
  try {
    const saved = localStorage.getItem(FORM_SAVE_KEY);
    if (!saved) return false;
    
    const formData = JSON.parse(saved);
    // Only restore if less than 7 days old
    if (Date.now() - (formData._timestamp || 0) > 7 * 24 * 60 * 60 * 1000) {
      localStorage.removeItem(FORM_SAVE_KEY);
      return false;
    }
    
    // Restore all form fields
    if (formData.name) document.getElementById('biz-name').value = formData.name;
    if (formData.industry) document.getElementById('biz-industry').value = formData.industry;
    if (formData.description) document.getElementById('biz-description').value = formData.description;
    if (formData.country) document.getElementById('biz-country').value = formData.country;
    if (formData.city) document.getElementById('biz-city').value = formData.city;
    if (formData.delivery) document.getElementById('biz-delivery').value = formData.delivery;
    if (formData.customer) document.getElementById('biz-customer').value = formData.customer;
    if (formData.existingDocs) document.getElementById('biz-docs').value = formData.existingDocs;
    if (formData.products) document.getElementById('biz-products').value = formData.products;
    if (formData.userName) document.getElementById('user-name').value = formData.userName;
    if (formData.userEmail) document.getElementById('user-email').value = formData.userEmail;
    
    // Restore radio buttons
    if (formData.salesChannel) {
      const scRadio = document.querySelector(`input[name="sales-channel"][value="${formData.salesChannel}"]`);
      if (scRadio) scRadio.checked = true;
    }
    if (formData.paymentModel) {
      const pmValues = formData.paymentModel.split(', ');
      pmValues.forEach(val => {
        const pmRadio = document.querySelector(`input[name="pay-model"][value="${val}"]`);
        if (pmRadio) pmRadio.checked = true;
      });
    }
    if (formData.bizSize) {
      const bsRadio = document.querySelector(`input[name="biz-size"][value="${formData.bizSize}"]`);
      if (bsRadio) bsRadio.checked = true;
    }
    if (formData.brandTone) {
      const btRadio = document.querySelector(`input[name="brand-tone"][value="${formData.brandTone}"]`);
      if (btRadio) btRadio.checked = true;
    }
    
    // Restore step if valid
    if (formData._currentStep && formData._currentStep >= 1 && formData._currentStep <= 5) {
      // Show the saved step
      document.querySelectorAll('.form-step').forEach((step, idx) => {
        step.classList.toggle('active', idx + 1 === formData._currentStep);
      });
      currentStep = formData._currentStep;
      
      // Show indicator
      const banner = document.createElement('div');
      banner.style.cssText = `
        position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
        z-index: 1001; background: var(--gold); color: var(--ink);
        padding: 12px 20px; border-radius: 8px; box-shadow: 0 2px 16px rgba(0,0,0,.15);
        font-size: 13px; text-align: center;
      `;
      banner.innerHTML = `‚úì Form data restored ‚Äî continuing from Step ${formData._currentStep}`;
      document.body.appendChild(banner);
      setTimeout(() => banner.remove(), 4000);
    }
    
    return true;
  } catch(e) {
    console.warn('Could not restore form data:', e);
    return false;
  }
}

function clearFormData() {
  localStorage.removeItem(FORM_SAVE_KEY);
}

function setupFormAutoSave() {
  // Save on input/change with debounce
  const formInputs = document.querySelectorAll('#generator input, #generator textarea, #generator select');
  formInputs.forEach(input => {
    input.addEventListener('input', () => {
      clearTimeout(formSaveTimeout);
      formSaveTimeout = setTimeout(saveFormData, 1000); // Save 1 second after typing stops
    });
    input.addEventListener('change', saveFormData);
  });
  
  // Save on step change
  const originalNextStep = nextStep;
  window.nextStep = function(from) {
    saveFormData();
    return originalNextStep(from);
  };
}

// ‚îÄ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function scrollToGenerator() {
  document.getElementById('generator').scrollIntoView({ behavior: 'smooth' });
}

function nextStep(from) {
  if (!validateStep(from)) return;
  
  // If moving to preview step, populate it
  if (from === 3 && from + 1 === 4) {
    populatePreview();
  }
  
  // If moving to payment step, update order summary
  if (from + 1 === 5) {
    updateOrderSummary();
  }
  
  document.getElementById(`step-${from}`).classList.remove('active');
  document.getElementById(`step-${from + 1}`).classList.add('active');
  currentStep = from + 1;
}

function prevStep(from) {
  document.getElementById(`step-${from}`).classList.remove('active');
  document.getElementById(`step-${from - 1}`).classList.add('active');
  currentStep = from - 1;
}

function validateStep(step) {
  const err = document.getElementById('error-banner');
  err.classList.remove('show');
  if (step === 1) {
    if (!document.getElementById('biz-name').value.trim()) {
      showError('Please enter your business name.'); return false;
    }
    if (!document.getElementById('biz-industry').value) {
      showError('Please select your industry.'); return false;
    }
    if (!document.getElementById('biz-description').value.trim()) {
      showError('Please describe what your business does.'); return false;
    }
  }
  if (step === 2) {
    if (!document.querySelector('input[name="sales-channel"]:checked')) {
      showError('Please select how you get clients.'); return false;
    }
    if (!document.getElementById('biz-delivery').value.trim()) {
      showError('Please describe how you deliver your service.'); return false;
    }
  }
  if (step === 3) {
    if (!document.getElementById('biz-customer').value.trim()) {
      showError('Please describe your typical customer.'); return false;
    }
  }
  if (step === 4) {
    // Preview step - no validation needed
  }
  if (step === 5) {
    // Payment step - email validation happens in initPayment
  }
  return true;
}

function showError(msg) {
  const el = document.getElementById('error-banner');
  el.textContent = msg;
  el.classList.add('show');
}

// ‚îÄ‚îÄ‚îÄ FILE UPLOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function handleFileUpload(event) {
  const file = event.target.files[0];
  if (!file) {
    uploadedFile = null;
    uploadedFileContent = null;
    document.getElementById('file-info').classList.remove('show');
    return;
  }
  
  uploadedFile = file;
  const fileInfo = document.getElementById('file-info');
  const fileSize = (file.size / 1024).toFixed(1);
  fileInfo.textContent = `‚úì ${file.name} (${fileSize} KB)`;
  fileInfo.classList.add('show');
  
  // Read file content if it's a text file (for use in API call)
  if (file.type === 'text/plain' || file.name.endsWith('.txt') || file.name.endsWith('.md')) {
    const reader = new FileReader();
    reader.onload = function(e) {
      uploadedFileContent = e.target.result;
      // Optionally append to description if it's short and description is empty
      const desc = document.getElementById('biz-description');
      if (desc.value.trim().length < 50 && uploadedFileContent.length < 3000) {
        desc.value = desc.value.trim() + (desc.value.trim() ? '\n\n' : '') + uploadedFileContent;
      }
    };
    reader.readAsText(file);
  } else {
    uploadedFileContent = null;
  }
}

// ‚îÄ‚îÄ‚îÄ PREVIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function populatePreview() {
  const bizName = document.getElementById('biz-name').value.trim();
  const industry = document.getElementById('biz-industry').value;
  
  document.getElementById('preview-biz-name').textContent = bizName || 'your business';
  document.getElementById('preview-industry').textContent = industry || 'your industry';
}

// ‚îÄ‚îÄ‚îÄ COLLECT DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function collectData() {
  return {
    name: document.getElementById('biz-name').value.trim(),
    industry: document.getElementById('biz-industry').value,
    description: document.getElementById('biz-description').value.trim(),
    country: document.getElementById('biz-country').value.trim() || 'Nigeria',
    city: document.getElementById('biz-city').value.trim() || '',
    salesChannel: document.querySelector('input[name="sales-channel"]:checked')?.value || 'Multiple channels',
    delivery: document.getElementById('biz-delivery').value.trim(),
    paymentModel: Array.from(document.querySelectorAll('input[name="pay-model"]:checked')).map(cb => cb.value).join(', ') || 'Full payment upfront',
    bizSize: document.querySelector('input[name="biz-size"]:checked')?.value || 'Small team (2‚Äì10)',
    customer: document.getElementById('biz-customer').value.trim(),
    existingDocs: document.getElementById('biz-docs').value.trim(),
    products: document.getElementById('biz-products').value.trim(),
    brandTone: document.querySelector('input[name="brand-tone"]:checked')?.value || 'Professional & formal',
    userName: document.getElementById('user-name').value.trim(),
    userEmail: document.getElementById('user-email').value.trim(),
    uploadedFile: uploadedFile ? uploadedFile.name : null,
  };
}

// ‚îÄ‚îÄ‚îÄ PAYSTACK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function initPayment() {
  const email = document.getElementById('user-email').value.trim();
  if (!email) { 
    showError('Please enter your email address.'); 
    return; 
  }

  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    showError('Please enter a valid email address.');
    return;
  }

  // Check if Paystack key is configured
  if (CONFIG.PAYSTACK_PUBLIC_KEY.includes('YOUR_PAYSTACK')) {
    showError('Paystack is not configured. Please add your Paystack public key in the CONFIG section at the top of the script.');
    console.error('Paystack Error: Public key not configured.');
    console.error('Get your key from: https://dashboard.paystack.com/#/settings/developer');
    alert('‚ö†Ô∏è Paystack Configuration Required\n\nPlease add your Paystack public key in the CONFIG section of the code.\n\nGet your key from: https://dashboard.paystack.com/#/settings/developer');
    return;
  }

  const bizName = document.getElementById('biz-name').value.trim();
  const userName = document.getElementById('user-name').value.trim() || email.split('@')[0];
  
  // Disable button during payment
  const payBtn = document.getElementById('pay-btn');
  payBtn.disabled = true;
  payBtn.textContent = 'Processing...';

  // Check if PaystackPop is loaded
  // Direct check - sometimes PaystackPop is available even if window.paystackReady is false
  if (typeof PaystackPop === 'undefined') {
    if (window.paystackLoadError) {
      showError('Paystack payment system failed to load. Please refresh the page or check your internet connection.');
      payBtn.disabled = false;
      payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
      return;
    } else {
      showError('Paystack payment system is still loading. Please wait a moment and try again.');
      // Retry after 2 seconds
      setTimeout(() => {
        if (typeof PaystackPop !== 'undefined' && window.paystackReady) {
          payBtn.disabled = false;
          payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
          // Retry payment initialization
          initPayment();
        } else {
          payBtn.disabled = false;
          payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
        }
      }, 2000);
    }
    payBtn.disabled = false;
    payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
    return;
  }

  // Validate amount
  if (!CONFIG.PRICE_KOBO || CONFIG.PRICE_KOBO < 100) {
    showError('Invalid payment amount. Please contact support.');
    console.error('Invalid PRICE_KOBO:', CONFIG.PRICE_KOBO);
    payBtn.disabled = false;
    payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
    return;
  }

  // Validate email again
  if (!email || !email.includes('@')) {
    showError('Please enter a valid email address.');
    payBtn.disabled = false;
    payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
    return;
  }

  // Generate unique reference
  const paymentRef = 'BIZOS_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  console.log('Initializing Paystack payment:', {
    key: CONFIG.PAYSTACK_PUBLIC_KEY.substring(0, 20) + '...',
    email: email,
    amount: CONFIG.PRICE_KOBO,
    currency: 'NGN',
    ref: paymentRef
  });

  const handler = PaystackPop.setup({
    key: CONFIG.PAYSTACK_PUBLIC_KEY,
    email: email,
    amount: CONFIG.PRICE_KOBO,
    currency: 'NGN',
    ref: paymentRef,
    metadata: {
      custom_fields: [
        {
          display_name: "Business Name",
          variable_name: "business_name",
          value: bizName || 'N/A'
        },
        {
          display_name: "Customer Name",
          variable_name: "customer_name",
          value: userName || email.split('@')[0]
        }
      ]
    },
    callback: function(response) {
      console.log('Payment successful!', response);
      
      // Note: Payment verification happens on backend, but we proceed with generation
      // since Paystack callback means payment was successful
      
      try {
      // Store payment reference
      bizData.paymentReference = response.reference;
      bizData.paymentStatus = 'success';
      
      // Payment successful - start generation
      payBtn.disabled = false;
      payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
        
        // Close payment form and show generation screen
        const step5 = document.getElementById('step-5');
        const formCard = document.querySelector('.form-card');
        if (step5) step5.classList.remove('active');
        if (formCard) formCard.style.display = 'none';
        
        // Clear form data after successful payment
        clearFormData();
      
      // Start generation immediately after payment
        console.log('Starting generation after payment...');
        startGeneration().catch(err => {
          console.error('Generation failed after payment:', err);
          showError('Generation failed: ' + err.message + '. Please contact support with payment reference: ' + response.reference);
        });
      } catch (err) {
        console.error('Error in payment callback:', err);
        showError('Error processing payment: ' + err.message);
      }
    },
    onClose: function() {
      console.log('Payment window closed by user');
      payBtn.disabled = false;
      payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
    }
  });
  
  try {
    handler.openIframe();
    console.log('Paystack payment popup opened');
  } catch (error) {
    console.error('Error opening Paystack payment:', error);
    showError('Failed to open payment window: ' + (error.message || 'Unknown error') + '. Please try again or contact support.');
    payBtn.disabled = false;
    payBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M10 2L12.5 7.5H18L13.5 11L15.5 17L10 13.5L4.5 17L6.5 11L2 7.5H7.5L10 2Z" fill="white"/></svg> Pay ‚Ç¶15,000 with Paystack';
  }
  
  // Note: If you see a 400 error about "pay_with_transfer" in the console,
  // this is usually a Paystack account configuration issue (transfer payments not enabled).
  // Card payments should still work. Check your Paystack dashboard:
  // Settings ‚Üí Business ‚Üí Enable Transfer Payments (if needed)
}

// ‚îÄ‚îÄ‚îÄ BACKEND URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getBackendUrl() {
  if (CONFIG.BACKEND_TYPE === 'supabase') {
    // Supabase Edge Functions
    const isLocal = window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1';
    return isLocal 
      ? 'http://localhost:54321/functions/v1'  // Local Supabase
      : CONFIG.SUPABASE_URL;  // Production Supabase
  } else {
    // Vercel Functions (default)
    const hostname = window.location.hostname;
    const isLocal = hostname === 'localhost' || hostname === '127.0.0.1' ||
                    hostname.startsWith('192.168.') || hostname.startsWith('10.');
    return isLocal ? 'http://localhost:3001' : window.location.origin;
  }
}

// ‚îÄ‚îÄ‚îÄ API HELPER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function apiCall(endpoint, body) {
  const baseUrl = getBackendUrl();
  
  // Supabase uses /function-name, Vercel uses /api/endpoint
  let url;
  if (CONFIG.BACKEND_TYPE === 'supabase') {
    // Extract function name from endpoint (e.g., /api/generate-plan ‚Üí generate-plan)
    const functionName = endpoint.replace('/api/', '').replace('/', '');
    url = `${baseUrl}/${functionName}`;
  } else {
    url = `${baseUrl}${endpoint}`;
  }
  
  console.log(`API call [${CONFIG.BACKEND_TYPE}]: ${url}`);
  
  // Build headers
  const headers = { 'Content-Type': 'application/json' };
  
  // Add Supabase auth header if using Supabase
  if (CONFIG.BACKEND_TYPE === 'supabase' && CONFIG.SUPABASE_ANON_KEY && !CONFIG.SUPABASE_ANON_KEY.includes('YOUR_')) {
    headers['Authorization'] = `Bearer ${CONFIG.SUPABASE_ANON_KEY}`;
  }
  
  const response = await fetch(url, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(body)
  });

  if (!response.ok) {
    const errorText = await response.text();
    let error;
    try { 
      error = JSON.parse(errorText); 
    } catch { 
      error = { message: errorText }; 
    }
    
    // Enhanced error logging
    console.error(`API Error [${response.status}]:`, {
      url: url,
      status: response.status,
      statusText: response.statusText,
      error: error,
      rawResponse: errorText.substring(0, 500) // First 500 chars
    });
    
    const errorMsg = error.error || error.message || `Server error: ${response.status}`;
    const detailMsg = error.documentTitle ? ` (Document: ${error.documentTitle})` : '';
    throw new Error(errorMsg + detailMsg);
  }

  return response.json();
}

// ‚îÄ‚îÄ‚îÄ GENERATION STATE MANAGEMENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const GEN_STORAGE_KEY = 'bizos_generation_state';

function saveGenerationState(state) {
  try {
    localStorage.setItem(GEN_STORAGE_KEY, JSON.stringify({
      ...state,
      timestamp: Date.now()
    }));
  } catch(e) {
    console.warn('Could not save generation state:', e);
  }
}

function loadGenerationState() {
  try {
    const stored = localStorage.getItem(GEN_STORAGE_KEY);
    if (!stored) return null;
    const state = JSON.parse(stored);
    // Only resume if state is less than 1 hour old
    if (Date.now() - state.timestamp > 3600000) {
      localStorage.removeItem(GEN_STORAGE_KEY);
      return null;
    }
    return state;
  } catch(e) {
    console.warn('Could not load generation state:', e);
    return null;
  }
}

function clearGenerationState() {
  localStorage.removeItem(GEN_STORAGE_KEY);
}

// ‚îÄ‚îÄ‚îÄ GENERATION (SPLIT INTO MULTIPLE FAST CALLS + RESUME) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let generationTimer = null;
let generationStartTime = null;

// Global functions for folder downloads (must be global for onclick handlers)
function showFolderDownload(folderIndex, folderName, docCount) {
  const folderDownloads = document.getElementById('folder-downloads');
  const folderList = document.getElementById('folder-download-list');
  
  if (!folderDownloads || !folderList) return;
  
  folderDownloads.style.display = 'block';
  
  const downloadItem = document.createElement('div');
  downloadItem.style.cssText = 'display:flex;align-items:center;justify-content:space-between;padding:12px;background:var(--white);border-radius:8px;border:1px solid var(--line);';
  downloadItem.innerHTML = `
    <div>
      <div style="font-weight:500;color:var(--ink);">${folderName}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px;">${docCount} document${docCount !== 1 ? 's' : ''} ready</div>
    </div>
    <button class="btn-primary" onclick="downloadFolderZip(${folderIndex})" style="padding:8px 16px;font-size:14px;">
      Download
    </button>
  `;
  folderList.appendChild(downloadItem);
}

function downloadFolderZip(folderIndex) {
  if (!window.folderZips || !window.folderZips[folderIndex]) {
    console.error('Folder ZIP not found:', folderIndex);
    showError('Folder download not available yet. Please wait for generation to complete.');
    return;
  }
  
  const folderZip = window.folderZips[folderIndex];
  const url = URL.createObjectURL(folderZip.blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${folderZip.name}.zip`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  // Try to add log if available
  const log = document.getElementById('gen-log');
  if (log) {
    const line = document.createElement('div');
    line.className = 'log-line done';
    line.innerHTML = `<span class="log-dot"></span>‚úì Downloaded ${folderZip.folderName}`;
    log.appendChild(line);
    log.scrollTop = log.scrollHeight;
  }
}

// Global helper to add log messages (used by retry functions)
function addGlobalLog(text, done = false) {
  const log = document.getElementById('gen-log');
  if (!log) return;
  
  const line = document.createElement('div');
  line.className = `log-line ${done ? 'done' : ''}`;
  line.innerHTML = `<span class="log-dot"></span>${text}`;
  log.appendChild(line);
  log.scrollTop = log.scrollHeight;
}

async function retryFailedDocuments(failedDocs, folders, bizData, uploadedFileContent, zip, completedFolders, completedDocs) {
  let successCount = 0;
  const remainingFailed = [];
  const maxRetries = 3; // More retries for manual retry
  
  for (const failed of failedDocs) {
    const { folderIndex, folderName, docIndex, document } = failed;
    const folder = folders[folderIndex];
    const folderNameFormatted = `${String(folderIndex + 1).padStart(2,'0')} - ${folderName}`;
    
    addGlobalLog(`  ‚Üí Retrying ${document.title} in ${folderName}‚Ä¶`);
    
    let docSuccess = false;
    let retryCount = 0;
    
    while (!docSuccess && retryCount < maxRetries) {
      try {
        if (retryCount > 0) {
          addGlobalLog(`    ‚Üí Attempt ${retryCount + 1}/${maxRetries}‚Ä¶`);
          await new Promise(r => setTimeout(r, 2000 * retryCount)); // Longer backoff for retries
        }
        
        const docResult = await apiCall('/api/generate-document', {
          businessData: bizData,
          document: document,
          folderName: folderName,
          uploadedFileContent: uploadedFileContent || null
        });

        if (!docResult.success || !docResult.doc) {
          throw new Error(docResult.message || docResult.error || 'API returned unsuccessful response');
        }
        
        // Validate doc has proper content
        if (!docResult.doc.sections || !Array.isArray(docResult.doc.sections) || docResult.doc.sections.length === 0) {
          throw new Error('Document has no sections');
        }
        
        const hasContent = docResult.doc.sections.some(s => 
          s.content && s.content.trim().length > 50
        );
        
        if (!hasContent) {
          throw new Error('Document has insufficient content');
        }
        
        // Success! Add to ZIP and update completed lists
        try {
          const docxBlob = await generateDocx(docResult.doc, bizData);
          zip.folder(bizData.name).folder(folderNameFormatted).file((document.filename || document.title.replace(/\s+/g,'_')) + '.docx', docxBlob);
          
          // Update completed folders/docs
          const existingFolder = completedFolders.find(cf => cf.index === folderIndex);
          if (existingFolder) {
            existingFolder.docs.push(docResult.doc);
          } else {
            completedFolders.push({
              index: folderIndex,
              name: folderName,
              docs: [docResult.doc]
            });
          }
          completedDocs.push(docResult.doc);
          
          successCount++;
          docSuccess = true;
          addGlobalLog(`  ‚úì ${document.title} ‚Äî retry successful!`, true);
        } catch (docxErr) {
          console.error('Error creating DOCX for retried doc:', docxErr);
          throw new Error('Failed to create document file');
        }
      } catch (retryErr) {
        retryCount++;
        console.error(`Retry attempt ${retryCount} failed for ${document.title}:`, retryErr);
        
        if (retryCount >= maxRetries) {
          addGlobalLog(`  ‚ö†Ô∏è ${document.title} ‚Äî still failed after ${maxRetries} retry attempts`, false);
          remainingFailed.push(failed);
        }
      }
    }
  }
  
  return { successCount, remainingFailed };
}

async function retryAllFailedDocuments() {
  if (!window.failedDocsForRetry || window.failedDocsForRetry.length === 0) {
    addGlobalLog('No failed documents to retry', false);
    return;
  }
  
  const failedDocs = window.failedDocsForRetry;
  const savedState = loadGenerationState();
  
  if (!savedState || !savedState.folders) {
    addGlobalLog('Error: Cannot find generation state. Please start a new generation.', false);
    return;
  }
  
  addGlobalLog(`Retrying ${failedDocs.length} failed document${failedDocs.length !== 1 ? 's' : ''}‚Ä¶`, true);
  
  // Get current ZIP and state
  const zip = new JSZip();
  const bizData = savedState.bizData;
  const folders = savedState.folders;
  const completedFolders = savedState.completedFolders || [];
  const completedDocs = savedState.completedDocs || [];
  
  // Rebuild existing ZIP
  for (const cf of completedFolders) {
    const folderName = `${String(cf.index + 1).padStart(2,'0')} - ${cf.name}`;
    for (const doc of cf.docs) {
      try {
        const docxBlob = await generateDocx(doc, bizData);
        zip.folder(bizData.name).folder(folderName).file((doc.filename || doc.title.replace(/\s+/g,'_')) + '.docx', docxBlob);
      } catch(e) {
        console.error('Error rebuilding doc:', doc.filename, e);
      }
    }
  }
  
  const uploadedFileContent = null; // Could be stored in state if needed
  
  // Call retryFailedDocuments
  const retryResults = await retryFailedDocuments(
    failedDocs, 
    folders, 
    bizData, 
    uploadedFileContent, 
    zip, 
    completedFolders, 
    completedDocs
  );
  
  if (retryResults.successCount > 0) {
    addGlobalLog(`‚úì Successfully retried ${retryResults.successCount} document${retryResults.successCount !== 1 ? 's' : ''}`, true);
    
    // Update final ZIP
    const zipBlob = await zip.generateAsync({ type: 'blob' });
    generatedZip = { blob: zipBlob, name: bizData.name };
    
    // Update download button
    const downloadBtn = document.getElementById('download-btn');
    if (downloadBtn) {
      downloadBtn.onclick = downloadZip;
      downloadBtn.textContent = 'Download Complete System';
    }
  }
  
  if (retryResults.remainingFailed.length > 0) {
    addGlobalLog(`‚ö†Ô∏è ${retryResults.remainingFailed.length} document${retryResults.remainingFailed.length !== 1 ? 's' : ''} still failed`, false);
    window.failedDocsForRetry = retryResults.remainingFailed;
  } else {
    // All retries successful
    window.failedDocsForRetry = [];
    clearGenerationState();
    addGlobalLog('‚úì All documents generated successfully!', true);
  }
}

async function startGeneration(resumeFromSaved = false) {
  console.log('=== START GENERATION ===', resumeFromSaved ? '(RESUMING)' : '(NEW)');
  
  let savedState = null;
  if (resumeFromSaved) {
    savedState = loadGenerationState();
    if (!savedState) {
      resumeFromSaved = false;
      console.log('No valid saved state found, starting fresh');
    }
  }

  if (!resumeFromSaved) {
  bizData = collectData();
    clearGenerationState();
  } else {
    bizData = savedState.bizData;
    console.log('Resuming from saved state:', {
      completedFolders: savedState.completedFolders?.length || 0,
      totalFolders: savedState.folders?.length || 0
    });
  }

  // Show generation screen
  const genScreen = document.getElementById('generation-screen');
  genScreen.classList.add('active');
  document.body.style.overflow = 'hidden';

  const log = document.getElementById('gen-log');
  const progress = document.getElementById('progress-fill');
  const genTitle = document.getElementById('gen-title');
  const genSub = document.getElementById('gen-sub');
  const genPhase = document.getElementById('gen-phase');
  const genTime = document.getElementById('gen-time');
  const genError = document.getElementById('gen-error');

  // Reset or restore UI
  if (!resumeFromSaved) {
    log.innerHTML = '';
    progress.style.width = '0%';
    genError.style.display = 'none';
    genTitle.textContent = 'Building your system‚Ä¶';
    genSub.textContent = 'Your payment was successful. Generating your complete business operating system now.';
    generationStartTime = Date.now();
  } else {
    genError.style.display = 'none';
    genTitle.textContent = 'Resuming generation‚Ä¶';
    genSub.textContent = `Continuing from where we left off. ${savedState.completedFolders?.length || 0} of ${savedState.folders?.length || 0} folders already completed.`;
    addLog('Resuming generation‚Ä¶', false);
    addLog(`Previously completed: ${savedState.completedFolders?.map(f => f.name).join(', ') || 'none'}`, true);
    generationStartTime = savedState.startTime || Date.now();
  }
  
  const startTime = generationStartTime;
  let elapsedInterval = null;
  let folderStartTimes = {}; // Track when each folder starts
  let folderDurations = []; // Track how long each folder took
  let totalFolders = 0; // Will be set when we know folder count

  function updateTimer() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const mins = Math.floor(elapsed / 60);
    const secs = elapsed % 60;
    const elapsedText = `Time elapsed: ${mins}:${String(secs).padStart(2,'0')}`;
    
    // Calculate estimate if we have enough data
    let estimateText = '';
    if (totalFolders > 0 && folderDurations.length > 0) {
      const avgTimePerFolder = folderDurations.reduce((a, b) => a + b, 0) / folderDurations.length;
      const completedFolders = folderDurations.length;
      const remainingFolders = totalFolders - completedFolders;
      
      if (remainingFolders > 0) {
        // Estimate: average time per folder * remaining folders
        // Add 10 seconds for ZIP packaging
        const estimatedSeconds = Math.ceil(avgTimePerFolder * remainingFolders + 10);
        const estMins = Math.floor(estimatedSeconds / 60);
        const estSecs = estimatedSeconds % 60;
        
        if (estMins > 0) {
          estimateText = ` ‚Ä¢ Est. remaining: ~${estMins}m ${estSecs}s`;
        } else {
          estimateText = ` ‚Ä¢ Est. remaining: ~${estSecs}s`;
        }
      } else {
        estimateText = ` ‚Ä¢ Almost done!`;
      }
    } else if (totalFolders > 0) {
      // Initial estimate: ~20 seconds per folder (conservative)
      const initialEstimate = totalFolders * 20 + 10; // +10 for ZIP
      const estMins = Math.floor(initialEstimate / 60);
      const estSecs = initialEstimate % 60;
      if (estMins > 0) {
        estimateText = ` ‚Ä¢ Est. total: ~${estMins}m ${estSecs}s`;
      } else {
        estimateText = ` ‚Ä¢ Est. total: ~${estSecs}s`;
      }
    }
    
    genTime.textContent = `${elapsedText}${estimateText} ‚Äî Please keep this window open`;
  }
  elapsedInterval = setInterval(updateTimer, 1000);
  updateTimer();

  function addLog(text, done = false) {
    const line = document.createElement('div');
    line.className = `log-line ${done ? 'done' : ''}`;
    line.innerHTML = `<span class="log-dot"></span>${text}`;
    log.appendChild(line);
    
    // Auto-scroll to bottom - multiple methods for cross-browser/mobile compatibility
    const scrollToBottom = () => {
    log.scrollTop = log.scrollHeight;
      // Also try scrollIntoView for better mobile support
      if (line.scrollIntoView) {
        line.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    };
    
    // Immediate scroll
    scrollToBottom();
    
    // Delayed scroll after DOM update (for mobile browsers)
    setTimeout(scrollToBottom, 50);
    
    // Also use requestAnimationFrame for smoother scrolling
    requestAnimationFrame(() => {
      scrollToBottom();
    });
  }

  function setProgress(pct) {
    progress.style.width = Math.min(pct, 100) + '%';
  }

  function setPhase(step, total, text) {
    genPhase.textContent = `Step ${step} of ${total} ‚Äî ${text}`;
  }

  function showGenError(msg, canResume = false) {
    clearInterval(elapsedInterval);
    genTitle.textContent = 'Generation paused';
    genSub.textContent = canResume 
      ? 'Your progress has been saved. You can resume from where you left off.'
      : 'An error occurred, but your payment is safe. You can retry immediately.';
    genPhase.textContent = '';
    genError.style.display = 'block';
    document.getElementById('gen-error-msg').textContent = msg;
    const ref = bizData.paymentReference || '';
    document.getElementById('gen-error-ref').textContent = ref ? `Payment reference: ${ref}` : '';
    const retryBtn = document.getElementById('gen-retry-btn');
    if (canResume) {
      retryBtn.textContent = 'Resume Generation';
      retryBtn.onclick = () => retryGeneration();
    } else {
      retryBtn.textContent = 'Try Again';
      retryBtn.onclick = () => retryGeneration();
    }
  }


  // retryFailedDocuments is now global (defined above)

  function showFailedDocumentsRetry(failedDocs) {
    const folderDownloads = document.getElementById('folder-downloads');
    if (!folderDownloads) return;
    
    folderDownloads.style.display = 'block';
    
    const folderList = document.getElementById('folder-download-list');
    const retrySection = document.createElement('div');
    retrySection.style.cssText = 'margin-top:24px;padding:20px;background:var(--white);border-radius:12px;border:2px solid var(--gold);';
    retrySection.innerHTML = `
      <div style="font-weight:600;margin-bottom:12px;color:var(--ink);">‚ö†Ô∏è Failed Documents</div>
      <div style="font-size:14px;color:var(--muted);margin-bottom:16px;">
        ${failedDocs.length} document${failedDocs.length !== 1 ? 's' : ''} failed to generate. You can retry them now.
      </div>
      <button class="btn-primary" onclick="retryAllFailedDocuments()" style="padding:12px 24px;font-size:16px;width:100%;">
        Retry Failed Documents
      </button>
    `;
    folderList.appendChild(retrySection);
    
    // Store failed docs for retry
    window.failedDocsForRetry = failedDocs;
  }


  try {
    // ‚îÄ‚îÄ CHECK PRODUCT TYPE: Business Plan vs Full System ‚îÄ‚îÄ
    if (selectedProductType === 'BUSINESS_PLAN') {
      // Generate business plan only
      setPhase(1, 1, 'Generating business plan');
      addLog('Creating your comprehensive business plan‚Ä¶');
      setProgress(10);
      
      genTitle.textContent = 'Building your business plan‚Ä¶';
      genSub.textContent = 'Your payment was successful. Generating your comprehensive one-page business plan now.';
      
      const planResult = await apiCall('/api/generate-business-plan', {
        businessData: bizData,
        uploadedFileContent: uploadedFileContent
      });
      
      if (!planResult.success || !planResult.sections) {
        throw new Error(planResult.message || 'Failed to generate business plan');
      }
      
      addLog(`Business plan generated ‚Äî ${planResult.sections.length} sections`, true);
      setProgress(90);
      
      // Generate DOCX for business plan
      addLog('Formatting business plan document‚Ä¶');
      const businessPlanDoc = {
        title: `${bizData.name} - Business Plan`,
        filename: `${bizData.name.replace(/\s+/g, '_')}_Business_Plan`,
        sections: planResult.sections
      };
      
      const docxBlob = await generateBusinessPlanDocx(businessPlanDoc, bizData);
      setProgress(95);
      
      // Create ZIP with single document
      const zip = new JSZip();
      zip.file(`${businessPlanDoc.filename}.docx`, docxBlob);
      
      addLog('Business plan ready!', true);
      setProgress(100);
      
      // Download
      generatedZip = await zip.generateAsync({ type: 'blob' });
      const url = URL.createObjectURL(generatedZip);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${bizData.name.replace(/\s+/g, '_')}_Business_Plan.zip`;
      a.click();
      
      clearInterval(elapsedInterval);
      genTitle.textContent = 'Business plan ready!';
      genSub.textContent = 'Your comprehensive business plan has been generated and downloaded.';
      genPhase.textContent = '';
      
      setTimeout(() => {
        genScreen.classList.remove('active');
        document.body.style.overflow = '';
        showDownloadScreen();
      }, 2000);
      
      return; // Exit early for business plan
    }
    
    // ‚îÄ‚îÄ FULL SYSTEM GENERATION (original flow) ‚îÄ‚îÄ
    let folders, zip, completedFolders, completedDocs;
    
    // ‚îÄ‚îÄ PHASE 1: Get document structure plan (or use saved) ‚îÄ‚îÄ
    if (resumeFromSaved && savedState.plan) {
      folders = savedState.folders;
      completedFolders = savedState.completedFolders || [];
      completedDocs = savedState.completedDocs || [];
      zip = new JSZip();
      
      // Rebuild ZIP from saved folders
      for (const cf of completedFolders) {
        const folderName = `${String(cf.index + 1).padStart(2,'0')} - ${cf.name}`;
        for (const doc of cf.docs) {
          try {
            const docxBlob = await generateDocx(doc, bizData);
            zip.folder(bizData.name).folder(folderName).file((doc.filename || doc.title.replace(/\s+/g,'_')) + '.docx', docxBlob);
          } catch(e) {
            console.error('Error rebuilding doc:', doc.filename, e);
          }
        }
      }
      
      addLog(`Resuming ‚Äî ${completedFolders.length} folders already done`, true);
      setProgress(12 + Math.round((completedFolders.length / folders.length) * 80));
      totalFolders = folders.length; // Set for timer estimates
    } else {
      setPhase(1, 8, 'Planning document structure');
    addLog('Analysing your business profile‚Ä¶');
      setProgress(5);

      const planResult = await apiCall('/api/generate-plan', {
        businessData: bizData
      });

      if (!planResult.success || !planResult.plan) {
        throw new Error(planResult.message || 'Failed to create document plan');
      }

      folders = planResult.plan.folders || [];
      const totalDocs = folders.reduce((sum, f) => sum + (f.docs?.length || 0), 0);
      
      addLog(`Document plan ready ‚Äî ${totalDocs} documents across ${folders.length} folders`, true);
      setProgress(12);
      
      zip = new JSZip();
      completedFolders = [];
      completedDocs = [];
      totalFolders = folders.length; // Set for timer estimates
      
      // Save initial state
      saveGenerationState({
        bizData: bizData,
        plan: planResult.plan,
        folders: folders,
        completedFolders: [],
        completedDocs: [],
        startTime: startTime
      });
    }

    // ‚îÄ‚îÄ PHASE 2-8: Generate content per folder (skip completed) ‚îÄ‚îÄ
    let docsGenerated = completedDocs.length || 0;
    let foldersCompleted = completedFolders.length || 0;
    let failedDocs = []; // Track failed documents for retry

    for (let fi = 0; fi < folders.length; fi++) {
      // Skip if already completed
      if (resumeFromSaved && completedFolders.some(cf => cf.index === fi)) {
        continue;
      }
      
      const folder = folders[fi];
      const stepNum = fi + 2;
      const totalSteps = folders.length + 1;
      
      // Track folder start time
      folderStartTimes[fi] = Date.now();
      
      setPhase(stepNum, totalSteps, `Writing ${folder.name}`);
      addLog(`Generating ${folder.name} (${folder.docs.length} documents)‚Ä¶`);
      genTitle.textContent = `Writing ${folder.name}‚Ä¶`;

      // Generate documents ONE AT A TIME to avoid timeouts
      let folderDocs = [];

      for (let di = 0; di < folder.docs.length; di++) {
        const doc = folder.docs[di];
        addLog(`  ‚Üí ${doc.title}‚Ä¶`);
        
        let docContent;
        let docSuccess = false;
        let retryCount = 0;
        const maxRetries = 2;
        
        // Validate business data before API call (prevent token waste)
        if (!bizData.name || !bizData.industry || !bizData.description) {
          console.error(`Skipping ${doc.title} - missing required business data`);
          addLog(`  ‚ö†Ô∏è ${doc.title} ‚Äî skipped (missing business data)`, false);
          continue; // Skip this document
        }
        
        while (!docSuccess && retryCount <= maxRetries) {
          try {
            if (retryCount > 0) {
              addLog(`  ‚Üí Retrying ${doc.title} (attempt ${retryCount + 1}/${maxRetries + 1})‚Ä¶`);
              // Wait before retry (exponential backoff: 1s, 2s)
              await new Promise(r => setTimeout(r, 1000 * retryCount));
            }
            
            const docResult = await apiCall('/api/generate-document', {
              businessData: bizData,
              document: doc,
              folderName: folder.name,
              uploadedFileContent: uploadedFileContent || null
            });

            if (!docResult.success || !docResult.doc) {
              console.error(`Document ${doc.title} API returned error:`, docResult);
              throw new Error(docResult.message || docResult.error || 'API returned unsuccessful response');
            }
            
            // Validate doc has proper content
            if (!docResult.doc.sections || !Array.isArray(docResult.doc.sections) || docResult.doc.sections.length === 0) {
              throw new Error('Document has no sections');
            }
            
            const hasContent = docResult.doc.sections.some(s => 
              s.content && s.content.trim().length > 50
            );
            
            if (!hasContent) {
              throw new Error('Document has insufficient content');
            }
            
            docContent = docResult.doc;
            docSuccess = true;
            if (retryCount > 0) {
              addLog(`  ‚úì ${doc.title} complete (retry ${retryCount})`, true);
            } else {
              addLog(`  ‚úì ${doc.title} complete`, true);
            }
            console.log(`Document ${doc.title} success: ${docContent.sections.length} sections`);
          } catch (docErr) {
            retryCount++;
            console.error(`Error generating ${doc.title} (attempt ${retryCount}):`, docErr);
            
            // Check if it's a network/timeout error
            const isNetworkError = docErr.message.includes('Failed to fetch') || 
                                  docErr.message.includes('NetworkError') ||
                                  docErr.message.includes('timeout') ||
                                  docErr.message.includes('FUNCTION_INVOCATION_TIMEOUT') ||
                                  docErr.message.includes('429'); // Rate limit
            
            // If it's a network error and we've exhausted retries, save state
            if (isNetworkError && retryCount > maxRetries) {
              addLog(`Network/timeout error ‚Äî ${folder.name} paused`, false);
              saveGenerationState({
                bizData: bizData,
                plan: { folders: folders },
                folders: folders,
                completedFolders: completedFolders,
                completedDocs: completedDocs,
                startTime: startTime,
                lastError: docErr.message
              });
              
              showGenError(`Generation timeout while creating ${doc.title} in ${folder.name}. Your progress has been saved.`, true);
              return; // Exit, user can resume
            }
            
            // If we've exhausted retries, track for retry later (don't waste tokens on placeholders)
            if (retryCount > maxRetries) {
              console.error(`All retries exhausted for ${doc.title}, tracking for retry`);
              addLog(`  ‚ö†Ô∏è ${doc.title} ‚Äî failed after ${maxRetries + 1} attempts`, false);
              addLog(`     Will retry at the end. Continuing with other documents...`, false);
              
              // Track failed document for retry
              failedDocs.push({
                folderIndex: fi,
                folderName: folder.name,
                docIndex: di,
                document: doc,
                error: docErr.message
              });
              
              docSuccess = false; // Mark as failed, but continue
              break; // Exit retry loop, continue to next document
            }
          }
        }
        
        if (docContent) {
          folderDocs.push(docContent);
        }
      }
      
      // If folder has no documents, track all failed docs for retry
      if (folderDocs.length === 0) {
        addLog(`‚ö†Ô∏è ${folder.name} ‚Äî all documents failed. Will retry at the end.`, false);
        // All docs in this folder are already tracked in failedDocs
        continue; // Skip this folder for now, but we'll retry failed docs later
      }

      // Build .docx files for this folder (with validation)
      const folderName = `${String(fi+1).padStart(2,'0')} - ${folder.name}`;
      let folderDocsAdded = 0;
      
      for (const doc of folderDocs) {
        try {
          // Validate document has content
          if (!doc.sections || !Array.isArray(doc.sections) || doc.sections.length === 0) {
            console.warn(`Document ${doc.filename || doc.title} has no sections, adding default`);
            doc.sections = [{
              heading: doc.title || 'Overview',
              content: `This document contains information relevant to ${bizData.name} in the ${bizData.industry} industry.`
            }];
          }
          
          // Ensure at least one section has meaningful content
          const hasContent = doc.sections.some(s => 
            s.content && s.content.trim().length >= 50
          );
          
          if (!hasContent) {
            console.warn(`Document ${doc.filename || doc.title} has insufficient content, enhancing`);
            doc.sections[0].content = doc.sections[0].content || 
              `This document contains information relevant to ${bizData.name} in the ${bizData.industry} industry.`;
            // Ensure minimum length
            if (doc.sections[0].content.trim().length < 100) {
              doc.sections[0].content += ` This document is part of your complete business operating system and should be customized to your specific needs.`;
            }
          }
          
          const docxBlob = await generateDocx(doc, bizData);
          zip.folder(bizData.name).folder(folderName).file((doc.filename || doc.title.replace(/\s+/g,'_')) + '.docx', docxBlob);
          docsGenerated++;
          folderDocsAdded++;
        } catch(e) {
          console.error('Doc gen error:', doc.filename, e);
        }
      }
      
      // If no documents were added, skip this folder (don't waste tokens)
      if (folderDocsAdded === 0) {
        addLog(`‚ö†Ô∏è ${folder.name} ‚Äî no valid documents. Skipping folder.`, false);
        continue; // Skip this folder, move to next
      }

      // Save completed folder to state
      completedFolders.push({
        index: fi,
        name: folder.name,
        docs: folderDocs
      });
      completedDocs.push(...folderDocs);
      
      // Track folder completion time
      if (folderStartTimes[fi]) {
        const folderDuration = Math.floor((Date.now() - folderStartTimes[fi]) / 1000);
        folderDurations.push(folderDuration);
        delete folderStartTimes[fi];
      }
      
      foldersCompleted++;
      const pct = 12 + Math.round((foldersCompleted / folders.length) * 80);
      setProgress(pct);
      addLog(`${folder.name} complete ‚Äî ${folderDocs.length} files`, true);
      
      // Create incremental ZIP for this folder (for immediate download)
      try {
        const folderZip = new JSZip();
        const folderZipFolder = folderZip.folder(bizData.name).folder(folderName);
        for (const doc of folderDocs) {
          try {
            const docxBlob = await generateDocx(doc, bizData);
            folderZipFolder.file((doc.filename || doc.title.replace(/\s+/g,'_')) + '.docx', docxBlob);
          } catch(e) {
            console.error('Error adding doc to folder ZIP:', e);
          }
        }
        const folderZipBlob = await folderZip.generateAsync({ type: 'blob' });
        
        // Store folder ZIP for download
        if (!window.folderZips) window.folderZips = {};
        window.folderZips[fi] = {
          blob: folderZipBlob,
          name: `${bizData.name}_${folderName.replace(/\s+/g,'_')}`,
          folderName: folder.name,
          docCount: folderDocs.length
        };
        
        // Show download button for this folder
        showFolderDownload(fi, folder.name, folderDocs.length);
      } catch(e) {
        console.error('Error creating folder ZIP:', e);
      }
      
      // Save progress after each folder
      saveGenerationState({
        bizData: bizData,
        plan: { folders: folders },
        folders: folders,
        completedFolders: completedFolders,
        completedDocs: completedDocs,
        startTime: startTime
      });
    }

    // ‚îÄ‚îÄ RETRY FAILED DOCUMENTS ‚îÄ‚îÄ
    if (failedDocs.length > 0) {
      addLog(``, false);
      addLog(`Retrying ${failedDocs.length} failed document${failedDocs.length !== 1 ? 's' : ''}‚Ä¶`, true);
      setPhase(folders.length + 1, folders.length + 2, 'Retrying failed documents');
      genTitle.textContent = `Retrying ${failedDocs.length} failed document${failedDocs.length !== 1 ? 's' : ''}‚Ä¶`;
      
      const retryResults = await retryFailedDocuments(failedDocs, folders, bizData, uploadedFileContent, zip, completedFolders, completedDocs);
      
      // Update counts
      docsGenerated += retryResults.successCount;
      failedDocs = retryResults.remainingFailed;
      
      if (retryResults.successCount > 0) {
        addLog(`‚úì Successfully retried ${retryResults.successCount} document${retryResults.successCount !== 1 ? 's' : ''}`, true);
      }
      
      if (retryResults.remainingFailed.length > 0) {
        addLog(`‚ö†Ô∏è ${retryResults.remainingFailed.length} document${retryResults.remainingFailed.length !== 1 ? 's' : ''} still failed after retry`, false);
        showFailedDocumentsRetry(retryResults.remainingFailed);
      }
    }

    // ‚îÄ‚îÄ FINAL: Package ZIP ‚îÄ‚îÄ
    const finalStep = failedDocs.length > 0 ? folders.length + 2 : folders.length + 1;
    setPhase(finalStep, finalStep, 'Packaging your files');
    genTitle.textContent = 'Packaging your files‚Ä¶';
    addLog('Creating ZIP archive‚Ä¶');
    setProgress(95);

    const zipBlob = await zip.generateAsync({ type: 'blob' });
    generatedZip = { blob: zipBlob, name: bizData.name };

    // Clear saved state on success (only if no failed docs remain)
    if (failedDocs.length === 0) {
      clearGenerationState();
    } else {
      // Save state with failed docs info for manual retry
      saveGenerationState({
        bizData: bizData,
        plan: { folders: folders },
        folders: folders,
        completedFolders: completedFolders,
        completedDocs: completedDocs,
        failedDocs: failedDocs,
        startTime: startTime
      });
    }

    setProgress(100);
    clearInterval(elapsedInterval);
    const totalTime = Math.floor((Date.now() - startTime) / 1000);
    const mins = Math.floor(totalTime / 60);
    const secs = totalTime % 60;
    genTime.textContent = `Completed in ${mins > 0 ? mins + 'm ' : ''}${secs}s`;
    addLog('Your business operating system is ready for download', true);

    // Send email with ZIP attachment (non-blocking)
    const userEmail = bizData.userEmail;
    if (userEmail) {
      // Check ZIP size - Vercel has ~4.5MB body limit, base64 adds ~33% overhead
      const maxEmailSize = 3 * 1024 * 1024; // 3MB raw = ~4MB base64
      if (zipBlob.size <= maxEmailSize) {
        addLog('Sending ZIP to your email‚Ä¶');
        try {
          const reader = new FileReader();
          reader.onload = async function() {
            const base64 = reader.result.split(',')[1];
            try {
              const emailResult = await apiCall('/api/send-email', {
                email: userEmail,
                businessName: bizData.name,
                zipBase64: base64,
                paymentReference: bizData.paymentReference || ''
              });
              if (emailResult.success && !emailResult.skipped) {
                addLog(`‚úì ZIP sent to ${userEmail}`, true);
              } else if (emailResult.skipped) {
                console.log('Email service not configured');
              } else {
                console.warn('Email sending failed:', emailResult.message);
              }
            } catch (emailErr) {
              console.error('Email error:', emailErr);
            }
          };
          reader.readAsDataURL(zipBlob);
        } catch(e) {
          console.error('Error preparing email:', e);
        }
      } else {
        console.log('ZIP too large for email (' + (zipBlob.size / 1024 / 1024).toFixed(1) + 'MB). Skipping email, download available.');
        addLog('ZIP ready for download (too large for email delivery)', true);
      }
    }

    await new Promise(r => setTimeout(r, 800));

    // Show download screen
    genScreen.classList.remove('active');
    document.getElementById('download-screen').classList.add('active');
    document.getElementById('dl-doc-count').textContent = docsGenerated;
    document.getElementById('dl-folder-count').textContent = folders.length;
    const emailNote = userEmail ? ` We've also sent it to ${userEmail}.` : '';
    document.getElementById('download-sub').textContent =
      `Your complete operating system for ${bizData.name} is ready. ${docsGenerated} professionally formatted documents across ${folders.length} organised folders.${emailNote}`;
    document.getElementById('download-btn').onclick = downloadZip;

  } catch(err) {
    console.error('=== GENERATION ERROR ===', err);
    
    // Save state on error (unless it's a critical error)
    const isNetworkError = err.message.includes('Failed to fetch') || 
                          err.message.includes('NetworkError');
    
    // Check if we have progress to save
    if (isNetworkError && typeof folders !== 'undefined' && typeof completedFolders !== 'undefined') {
      saveGenerationState({
        bizData: bizData,
        plan: { folders: folders },
        folders: folders,
        completedFolders: completedFolders,
        completedDocs: completedDocs || [],
        startTime: startTime,
        lastError: err.message
      });
      const progressMsg = completedFolders.length > 0 
        ? `Network connection lost. Your progress (${completedFolders.length}/${folders.length} folders) has been saved.`
        : `Network connection lost.`;
      showGenError(progressMsg, true);
    } else {
      showGenError(err.message || 'An unexpected error occurred. You can retry, or contact support with your payment reference.');
    }
  }
}

function retryGeneration() {
  // Check if there's saved state to resume from
  const savedState = loadGenerationState();
  const genError = document.getElementById('gen-error');
  genError.style.display = 'none';
  
  if (savedState && savedState.completedFolders && savedState.completedFolders.length > 0) {
    // Offer resume option
    const resume = confirm(`Resume generation? You have ${savedState.completedFolders.length} of ${savedState.folders?.length || 0} folders already completed.`);
    if (resume) {
      startGeneration(true); // Resume from saved state
      return;
    }
  }
  
  // Start fresh
  document.getElementById('gen-log').innerHTML = '';
  clearGenerationState();
  startGeneration(false);
}

function downloadZip() {
  if (!generatedZip) return;
  const url = URL.createObjectURL(generatedZip.blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = generatedZip.name.replace(/[^a-z0-9]/gi,'_') + '_Business_System.zip';
  a.click();
  URL.revokeObjectURL(url);
}

// ‚îÄ‚îÄ‚îÄ GENERATE DOCX CLIENT-SIDE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Uses docx.js loaded via CDN fallback ‚Äî we'll use a simple HTML‚ÜíBlob approach
// since docx.js CDN may vary. We generate proper .docx using Office XML.

async function generateDocx(doc, biz) {
  // Build a simple but professional .docx using Office Open XML
  const content = buildDocxXml(doc, biz);
  return content;
}

async function generateBusinessPlanDocx(planDoc, biz) {
  // Build a professional business plan DOCX with 9 sections
  const content = buildBusinessPlanDocxXml(planDoc, biz);
  return content;
}

function buildBusinessPlanDocxXml(planDoc, biz) {
  // Build sections from the plan data
  const sections = (planDoc.sections || []).map((section, idx) => {
    const isFirstSection = idx === 0;
    const headingLevel = isFirstSection ? 'Heading1' : 'Heading2';
    
    let sectionContent = `
    <w:p>
      <w:pPr>
        <w:pStyle w:val="${headingLevel}"/>
        <w:spacing w:before="${isFirstSection ? '360' : '280'}" w:after="120"/>
        ${isFirstSection ? '<w:keepNext/>' : ''}
        <w:borderBetween w:val="single" w:sz="6" w:space="1" w:color="C8963E"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:sz w:val="${isFirstSection ? '32' : '28'}"/><w:color w:val="${isFirstSection ? '1A3C5E' : '2C3E50'}"/></w:rPr>
        <w:t>${escapeXml(section.title || '')}</w:t>
      </w:r>
    </w:p>`;
    
    // Add content paragraphs
    sectionContent += wrapParagraphs(section.content || '', true);
    
    return sectionContent;
  }).join('');

  const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
  xmlns:mo="http://schemas.microsoft.com/office/mac/office/2008/main"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:mv="urn:schemas-microsoft-com:mac:vml"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
  xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"
  xmlns:v="urn:schemas-microsoft-com:vml"
  xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"
  xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
  xmlns:w10="urn:schemas-microsoft-com:office:word"
  xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"
  xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup"
  xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk"
  xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml"
  xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape"
  mc:Ignorable="w14 wp14">
  <w:body>
    <w:p>
      <w:pPr>
        <w:pStyle w:val="Heading1"/>
        <w:spacing w:before="0" w:after="180"/>
        <w:jc w:val="center"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:sz w:val="36"/><w:color w:val="1A3C5E"/></w:rPr>
        <w:t>${escapeXml(biz.name)}</w:t>
      </w:r>
    </w:p>
    <w:p>
      <w:pPr>
        <w:spacing w:before="0" w:after="360"/>
        <w:jc w:val="center"/>
        <w:borderBetween w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:sz w:val="28"/><w:color w:val="C8963E"/></w:rPr>
        <w:t>Comprehensive Business Plan</w:t>
      </w:r>
    </w:p>
    ${sections}
    <w:p>
      <w:pPr><w:spacing w:before="480"/></w:pPr>
      <w:r><w:rPr><w:sz w:val="18"/><w:color w:val="999999"/><w:i/></w:rPr>
        <w:t>Generated by BizOS ¬∑ ${new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}</w:t>
      </w:r>
    </w:p>
    <w:sectPr>
      <w:pgSz w:w="11906" w:h="16838"/>
      <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  // Use the same styles as regular documents
  const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:docDefaults>
    <w:rPrDefault><w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr></w:rPrDefault>
    <w:pPrDefault><w:pPr><w:spacing w:after="200" w:line="276" w:lineRule="auto"/></w:pPr></w:pPrDefault>
  </w:docDefaults>
  <w:style w:type="paragraph" w:styleId="Normal">
    <w:name w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:spacing w:after="200" w:line="276" w:lineRule="auto"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading1">
    <w:name w:val="heading 1"/>
    <w:basedOn w:val="Normal"/>
    <w:next w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:keepNext/><w:spacing w:before="480" w:after="0" w:line="276" w:lineRule="auto"/><w:outlineLvl w:val="0"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:b/><w:bCs/><w:sz w:val="32"/><w:szCs w:val="32"/><w:color w:val="1A3C5E"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading2">
    <w:name w:val="heading 2"/>
    <w:basedOn w:val="Normal"/>
    <w:next w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:keepNext/><w:spacing w:before="240" w:after="0" w:line="276" w:lineRule="auto"/><w:outlineLvl w:val="1"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/><w:color w:val="2C3E50"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading3">
    <w:name w:val="heading 3"/>
    <w:basedOn w:val="Normal"/>
    <w:next w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:keepNext/><w:spacing w:before="200" w:after="0" w:line="276" w:lineRule="auto"/><w:outlineLvl w:val="2"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:b/><w:bCs/><w:sz w:val="24"/><w:szCs w:val="24"/><w:color w:val="34495E"/></w:rPr>
  </w:style>
</w:styles>`;

  // Create DOCX structure (same as generateDocx)
  const zip = new JSZip();
  zip.file('word/document.xml', docXml);
  zip.file('word/styles.xml', stylesXml);
  zip.file('[Content_Types].xml', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`);
  zip.file('_rels/.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`);
  zip.file('word/_rels/document.xml.rels', `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`);

  return zip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
}

function buildDocxXml(doc, biz) {
  // Detect if document needs tables (expense tracking, budgets, invoices, etc.)
  const docTitle = (doc.title || '').toLowerCase();
  const needsTable = docTitle.includes('expense') || docTitle.includes('tracking') || 
                     docTitle.includes('budget') || docTitle.includes('invoice') ||
                     docTitle.includes('pipeline') || docTitle.includes('template') ||
                     docTitle.includes('tracker') || docTitle.includes('sheet') ||
                     docTitle.includes('dashboard') || docTitle.includes('report');
  
  // Build sections with proper hierarchy and strategic formatting
  const sections = (doc.sections || []).map((s, idx) => {
    const isFirstSection = idx === 0;
    const headingLevel = isFirstSection ? 'Heading1' : 'Heading2';
    
    let sectionContent = `
    <w:p>
      <w:pPr>
        <w:pStyle w:val="${headingLevel}"/>
        <w:spacing w:before="${isFirstSection ? '360' : '280'}" w:after="120"/>
        ${isFirstSection ? '<w:keepNext/>' : ''}
        <w:borderBetween w:val="single" w:sz="6" w:space="1" w:color="C8963E"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:sz w:val="${isFirstSection ? '32' : '28'}"/><w:color w:val="${isFirstSection ? '1A3C5E' : '2C3E50'}"/></w:rPr>
        <w:t>${escapeXml(s.heading || '')}</w:t>
      </w:r>
    </w:p>`;
    
    // Add content paragraphs with enhanced formatting
    sectionContent += wrapParagraphs(s.content || '', true);
    
    // Add strategic callout boxes for key insights
    if (s.content && (s.content.toLowerCase().includes('key') || s.content.toLowerCase().includes('important') || 
                      s.content.toLowerCase().includes('critical') || s.content.toLowerCase().includes('strategic'))) {
      sectionContent += addCalloutBox('Key Insight', extractKeyInsight(s.content));
    }
    
    // Add table if this section needs one (for expense/budget/tracking docs)
    if (needsTable && (s.heading?.toLowerCase().includes('track') || 
                       s.heading?.toLowerCase().includes('expense') ||
                       s.heading?.toLowerCase().includes('budget') ||
                       s.heading?.toLowerCase().includes('invoice') ||
                       s.heading?.toLowerCase().includes('pipeline') ||
                       s.heading?.toLowerCase().includes('dashboard') ||
                       idx === 0)) {
      sectionContent += generateTable(docTitle, s.heading);
    }
    
    // Add subsections if they exist
    if (s.subsections && Array.isArray(s.subsections) && s.subsections.length > 0) {
      s.subsections.forEach(subsec => {
        sectionContent += `
        <w:p>
          <w:pPr>
            <w:pStyle w:val="Heading3"/>
            <w:spacing w:before="200" w:after="80"/>
            <w:ind w:left="360"/>
          </w:pPr>
          <w:r>
            <w:rPr><w:b/><w:sz w:val="24"/><w:color w:val="34495E"/></w:rPr>
            <w:t>${escapeXml(subsec.heading || '')}</w:t>
          </w:r>
        </w:p>`;
        sectionContent += wrapParagraphs(subsec.content || '', false);
      });
    }
    
    // Add checklist if section mentions steps or actions
    if (s.content && (s.content.toLowerCase().includes('step') || s.content.toLowerCase().includes('action') || 
                      s.content.toLowerCase().includes('checklist'))) {
      sectionContent += addChecklist(s.content);
    }
    
    return sectionContent;
  }).join('');

  const docXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:wpc="http://schemas.microsoft.com/office/word/2010/wordprocessingCanvas"
  xmlns:mo="http://schemas.microsoft.com/office/mac/office/2008/main"
  xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
  xmlns:mv="urn:schemas-microsoft-com:mac:vml"
  xmlns:o="urn:schemas-microsoft-com:office:office"
  xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"
  xmlns:m="http://schemas.openxmlformats.org/officeDocument/2006/math"
  xmlns:v="urn:schemas-microsoft-com:vml"
  xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing"
  xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing"
  xmlns:w10="urn:schemas-microsoft-com:office:word"
  xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main"
  xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml"
  xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup"
  xmlns:wpi="http://schemas.microsoft.com/office/word/2010/wordprocessingInk"
  xmlns:wne="http://schemas.microsoft.com/office/word/2006/wordml"
  xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape"
  mc:Ignorable="w14 wp14">
  <w:body>
    <w:p>
      <w:pPr>
        <w:pStyle w:val="Heading1"/>
        <w:spacing w:before="0" w:after="180"/>
        <w:jc w:val="center"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:sz w:val="36"/><w:color w:val="1A3C5E"/></w:rPr>
        <w:t>${escapeXml(biz.name)}</w:t>
      </w:r>
    </w:p>
    <w:p>
      <w:pPr>
        <w:spacing w:before="0" w:after="360"/>
        <w:jc w:val="center"/>
        <w:borderBetween w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:sz w:val="28"/><w:color w:val="C8963E"/></w:rPr>
        <w:t>${escapeXml(doc.title)}</w:t>
      </w:r>
    </w:p>
    ${sections}
    <w:p>
      <w:pPr><w:spacing w:before="480"/></w:pPr>
      <w:r><w:rPr><w:sz w:val="18"/><w:color w:val="999999"/><w:i/></w:rPr>
        <w:t>Generated by BizOS ¬∑ ${new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'})}</w:t>
      </w:r>
    </w:p>
    <w:sectPr>
      <w:pgSz w:w="11906" w:h="16838"/>
      <w:pgMar w:top="1440" w:right="1440" w:bottom="1440" w:left="1440"/>
    </w:sectPr>
  </w:body>
</w:document>`;

  const stylesXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:styles xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main">
  <w:docDefaults>
    <w:rPrDefault><w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr></w:rPrDefault>
    <w:pPrDefault><w:pPr><w:spacing w:after="200" w:line="276" w:lineRule="auto"/></w:pPr></w:pPrDefault>
  </w:docDefaults>
  <w:style w:type="paragraph" w:styleId="Normal">
    <w:name w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:spacing w:after="200" w:line="276" w:lineRule="auto"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:sz w:val="22"/><w:szCs w:val="22"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading1">
    <w:name w:val="heading 1"/>
    <w:basedOn w:val="Normal"/>
    <w:next w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:keepNext/><w:spacing w:before="480" w:after="0" w:line="276" w:lineRule="auto"/><w:outlineLvl w:val="0"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:b/><w:bCs/><w:sz w:val="32"/><w:szCs w:val="32"/><w:color w:val="1A3C5E"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading2">
    <w:name w:val="heading 2"/>
    <w:basedOn w:val="Normal"/>
    <w:next w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:keepNext/><w:spacing w:before="240" w:after="0" w:line="276" w:lineRule="auto"/><w:outlineLvl w:val="1"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/><w:color w:val="2C3E50"/></w:rPr>
  </w:style>
  <w:style w:type="paragraph" w:styleId="Heading3">
    <w:name w:val="heading 3"/>
    <w:basedOn w:val="Normal"/>
    <w:next w:val="Normal"/>
    <w:qFormat/>
    <w:pPr><w:keepNext/><w:spacing w:before="200" w:after="0" w:line="276" w:lineRule="auto"/><w:outlineLvl w:val="2"/></w:pPr>
    <w:rPr><w:rFonts w:ascii="Calibri" w:hAnsi="Calibri" w:cs="Calibri"/><w:b/><w:bCs/><w:sz w:val="24"/><w:szCs w:val="24"/><w:color w:val="34495E"/></w:rPr>
  </w:style>
  <w:style w:type="table" w:styleId="TableGrid">
    <w:name w:val="Table Grid"/>
    <w:basedOn w:val="TableNormal"/>
    <w:tblPr>
      <w:tblBorders>
        <w:top w:val="single" w:sz="4" w:space="0" w:color="auto"/>
        <w:left w:val="single" w:sz="4" w:space="0" w:color="auto"/>
        <w:bottom w:val="single" w:sz="4" w:space="0" w:color="auto"/>
        <w:right w:val="single" w:sz="4" w:space="0" w:color="auto"/>
        <w:insideH w:val="single" w:sz="4" w:space="0" w:color="auto"/>
        <w:insideV w:val="single" w:sz="4" w:space="0" w:color="auto"/>
      </w:tblBorders>
    </w:tblPr>
  </w:style>
  <w:style w:type="table" w:styleId="TableNormal">
    <w:name w:val="Normal Table"/>
    <w:tblPr>
      <w:tblInd w:w="0" w:type="dxa"/>
      <w:tblCellMar>
        <w:top w:w="0" w:type="dxa"/>
        <w:left w:w="108" w:type="dxa"/>
        <w:bottom w:w="0" w:type="dxa"/>
        <w:right w:w="108" w:type="dxa"/>
      </w:tblCellMar>
    </w:tblPr>
  </w:style>
</w:styles>`;

  const relsXml = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/>
</Relationships>`;

  const appRels = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships">
  <Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="word/document.xml"/>
</Relationships>`;

  const contentTypes = `<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types">
  <Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/>
  <Default Extension="xml" ContentType="application/xml"/>
  <Override PartName="/word/document.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.document.main+xml"/>
  <Override PartName="/word/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.wordprocessingml.styles+xml"/>
</Types>`;

  // Build ZIP using JSZip
  const docZip = new JSZip();
  docZip.file('[Content_Types].xml', contentTypes);
  docZip.folder('_rels').file('.rels', appRels);
  const wordFolder = docZip.folder('word');
  wordFolder.file('document.xml', docXml);
  wordFolder.file('styles.xml', stylesXml);
  wordFolder.folder('_rels').file('document.xml.rels', relsXml);

  return docZip.generateAsync({ type: 'blob', mimeType: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
}

function generateTable(docTitle, sectionHeading) {
  const title = (docTitle + ' ' + sectionHeading).toLowerCase();
  let headers = [];
  let rows = 5; // Default 5 empty rows
  
  if (title.includes('expense') || title.includes('tracking')) {
    headers = ['Date', 'Description', 'Category', 'Amount', 'Payment Method', 'Notes'];
  } else if (title.includes('budget')) {
    headers = ['Category', 'Budgeted Amount', 'Actual Amount', 'Variance', 'Notes'];
  } else if (title.includes('invoice') || title.includes('receipt')) {
    headers = ['Item/Service', 'Description', 'Quantity', 'Unit Price', 'Total'];
  } else if (title.includes('pipeline') || title.includes('sales')) {
    headers = ['Client Name', 'Stage', 'Value', 'Expected Close Date', 'Next Action', 'Status'];
  } else if (title.includes('inventory') || title.includes('stock')) {
    headers = ['Item Name', 'SKU/Code', 'Quantity', 'Unit Cost', 'Total Value', 'Location'];
  } else {
    // Generic table
    headers = ['Item', 'Description', 'Status', 'Date', 'Notes'];
  }
  
  // Build table XML
  let tableXml = `
    <w:p>
      <w:pPr><w:spacing w:before="120" w:after="120"/></w:pPr>
    </w:p>
    <w:tbl>
      <w:tblPr>
        <w:tblStyle w:val="TableGrid"/>
        <w:tblW w:w="0" w:type="auto"/>
        <w:tblLook w:val="04A0" w:firstRow="1" w:lastRow="0" w:firstColumn="1" w:lastColumn="0" w:noHBand="0" w:noVBand="1"/>
      </w:tblPr>
      <w:tblGrid>
        ${headers.map(() => '<w:gridCol w:w="1500"/>').join('')}
      </w:tblGrid>
      <w:tr>
        ${headers.map(h => `
        <w:tc>
          <w:tcPr>
            <w:tcBorders>
              <w:top w:val="single" w:sz="4" w:space="0" w:color="1A3C5E"/>
              <w:left w:val="single" w:sz="4" w:space="0" w:color="1A3C5E"/>
              <w:bottom w:val="single" w:sz="4" w:space="0" w:color="1A3C5E"/>
              <w:right w:val="single" w:sz="4" w:space="0" w:color="1A3C5E"/>
            </w:tcBorders>
            <w:shd w:val="clear" w:color="auto" w:fill="1A3C5E"/>
          </w:tcPr>
          <w:p>
            <w:pPr><w:spacing w:before="120" w:after="120"/></w:pPr>
            <w:r>
              <w:rPr><w:b/><w:color w:val="FFFFFF"/><w:sz w:val="20"/></w:rPr>
              <w:t>${escapeXml(h)}</w:t>
            </w:r>
          </w:p>
        </w:tc>
        `).join('')}
      </w:tr>`;
  
  // Add empty rows for user to fill
  for (let i = 0; i < rows; i++) {
    tableXml += `
      <w:tr>
        ${headers.map(() => `
        <w:tc>
          <w:tcPr>
            <w:tcBorders>
              <w:top w:val="single" w:sz="4" w:space="0" w:color="D3D3D3"/>
              <w:left w:val="single" w:sz="4" w:space="0" w:color="D3D3D3"/>
              <w:bottom w:val="single" w:sz="4" w:space="0" w:color="D3D3D3"/>
              <w:right w:val="single" w:sz="4" w:space="0" w:color="D3D3D3"/>
            </w:tcBorders>
          </w:tcPr>
          <w:p>
            <w:pPr><w:spacing w:before="80" w:after="80"/></w:pPr>
            <w:r>
              <w:rPr><w:sz w:val="20"/><w:color w:val="999999"/></w:rPr>
              <w:t></w:t>
            </w:r>
          </w:p>
        </w:tc>
        `).join('')}
      </w:tr>`;
  }
  
  tableXml += `
    </w:tbl>
    <w:p>
      <w:pPr><w:spacing w:before="120" w:after="120"/></w:pPr>
    </w:p>`;
  
  return tableXml;
}

function extractKeyInsight(text) {
  // Extract a key insight sentence from the content
  const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
  const keySentences = sentences.filter(s => 
    s.toLowerCase().includes('key') || 
    s.toLowerCase().includes('important') ||
    s.toLowerCase().includes('critical') ||
    s.toLowerCase().includes('strategic') ||
    s.toLowerCase().includes('essential')
  );
  return keySentences[0]?.trim() || sentences[0]?.trim() || 'Key strategic insight from this section.';
}

function addCalloutBox(title, content) {
  return `
    <w:p>
      <w:pPr>
        <w:spacing w:before="120" w:after="120"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFF9E6"/>
        <w:pBdr>
          <w:top w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
          <w:left w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
          <w:bottom w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
          <w:right w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
        </w:pBdr>
        <w:ind w:left="360" w:right="360"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:b/><w:color w:val="C8963E"/><w:sz w:val="20"/></w:rPr>
        <w:t>${escapeXml(title)}</w:t>
      </w:r>
    </w:p>
    <w:p>
      <w:pPr>
        <w:spacing w:before="0" w:after="120"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFF9E6"/>
        <w:pBdr>
          <w:left w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
          <w:right w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
        </w:pBdr>
        <w:ind w:left="360" w:right="360"/>
      </w:pPr>
      <w:r>
        <w:rPr><w:sz w:val="20"/><w:color w:val="2C3E50"/></w:rPr>
        <w:t>${escapeXml(content)}</w:t>
      </w:r>
    </w:p>
    <w:p>
      <w:pPr>
        <w:spacing w:before="0" w:after="120"/>
        <w:shd w:val="clear" w:color="auto" w:fill="FFF9E6"/>
        <w:pBdr>
          <w:bottom w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
          <w:left w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
          <w:right w:val="single" w:sz="12" w:space="1" w:color="C8963E"/>
        </w:pBdr>
        <w:ind w:left="360" w:right="360"/>
      </w:pPr>
    </w:p>`;
}

function addChecklist(text) {
  // Extract action items from text
  const lines = text.split('\n').filter(l => l.trim());
  const actionItems = lines.filter(l => 
    l.trim().match(/^[‚Ä¢\-\d+\.]/) || 
    l.toLowerCase().includes('action:') ||
    l.toLowerCase().includes('step:') ||
    l.toLowerCase().includes('task:')
  ).slice(0, 8); // Max 8 items
  
  if (actionItems.length === 0) return '';
  
  return `
    <w:p>
      <w:pPr><w:spacing w:before="120" w:after="60"/></w:pPr>
      <w:r>
        <w:rPr><w:b/><w:color w:val="1A3C5E"/><w:sz w:val="22"/></w:rPr>
        <w:t>Implementation Checklist:</w:t>
      </w:r>
    </w:p>
    ${actionItems.map(item => {
      const cleanItem = item.replace(/^[‚Ä¢\-\d+\.]\s*/, '').replace(/^(action|step|task):\s*/i, '').trim();
      return `
      <w:p>
        <w:pPr>
          <w:ind w:left="560" w:hanging="280"/>
          <w:spacing w:before="40" w:after="40"/>
        </w:pPr>
        <w:r>
          <w:rPr><w:color w:val="C8963E"/><w:sz w:val="20"/></w:rPr>
          <w:sym w:font="Wingdings" w:char="F0FE"/>
        </w:r>
        <w:r>
          <w:rPr><w:sz w:val="20"/></w:rPr>
          <w:t xml:space="preserve"> ${escapeXml(cleanItem)}</w:t>
        </w:r>
      </w:p>`;
    }).join('')}
    <w:p>
      <w:pPr><w:spacing w:before="60" w:after="120"/></w:pPr>
    </w:p>`;
}

function wrapParagraphs(text, isMainSection = false) {
  if (!text) return '';
  return text.split('\n').filter(l => l.trim()).map(line => {
    if (line.trim().startsWith('‚Ä¢') || line.trim().startsWith('-') || line.trim().startsWith('‚óÜ')) {
      const content = line.replace(/^[‚Ä¢\-‚óÜ]\s*/, '');
      return `<w:p>
        <w:pPr><w:ind w:left="560" w:hanging="280"/><w:spacing w:before="60" w:after="60"/></w:pPr>
        <w:r><w:rPr><w:color w:val="C8963E"/></w:rPr><w:t xml:space="preserve">‚óÜ  </w:t></w:r>
        <w:r><w:rPr><w:sz w:val="22"/></w:rPr><w:t>${escapeXml(content)}</w:t></w:r>
      </w:p>`;
    }
    if (line.match(/^\d+\./)) {
      return `<w:p>
        <w:pPr><w:ind w:left="400"/><w:spacing w:before="60" w:after="60"/></w:pPr>
        <w:r><w:rPr><w:sz w:val="22"/></w:rPr><w:t>${escapeXml(line)}</w:t></w:r>
      </w:p>`;
    }
    return `<w:p>
      <w:pPr>
        <w:spacing w:before="${isMainSection ? '120' : '100'}" w:after="${isMainSection ? '120' : '100'}" w:line="276" w:lineRule="auto"/>
        ${isMainSection ? '<w:ind w:firstLine="0"/>' : ''}
      </w:pPr>
      <w:r>
        <w:rPr><w:sz w:val="22"/></w:rPr>
        <w:t xml:space="preserve">${escapeXml(line)}</w:t>
      </w:r>
    </w:p>`;
  }).join('');
}

function escapeXml(str) {
  return String(str || '')
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;')
    .replace(/'/g,'&apos;');
}

// ‚îÄ‚îÄ‚îÄ INITIALIZE ON PAGE LOAD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', function() {
  // Setup form auto-save
  setupFormAutoSave();
  
  // Restore form data if available
  restoreFormData();
  
  // Check for saved generation state
  const savedState = loadGenerationState();
  if (savedState && savedState.completedFolders && savedState.completedFolders.length > 0) {
    const totalFolders = savedState.folders?.length || 0;
    const completed = savedState.completedFolders.length;
    
    // Show a banner at the top offering to resume
    const banner = document.createElement('div');
    banner.setAttribute('data-resume-banner', '');
    banner.style.cssText = `
      position: fixed; top: 80px; left: 50%; transform: translateX(-50%);
      z-index: 1001; background: var(--gold); color: var(--ink);
      padding: 16px 24px; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,.2);
      max-width: 600px; text-align: center; font-size: 14px;
      display: flex; align-items: center; gap: 16px; flex-wrap: wrap; justify-content: center;
    `;
    banner.innerHTML = `
      <div style="flex: 1;">
        <strong>Generation in progress</strong><br>
        <span style="font-size: 12px; opacity: 0.8;">You have ${completed} of ${totalFolders} folders completed. Resume?</span>
      </div>
      <div style="display: flex; gap: 8px;">
        <button onclick="this.closest('[data-resume-banner]').remove(); startGeneration(true);" 
                style="background: var(--ink); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
          Resume
        </button>
        <button onclick="this.closest('[data-resume-banner]').remove(); clearGenerationState();" 
                style="background: transparent; color: var(--ink); border: 1px solid var(--ink); padding: 8px 16px; border-radius: 6px; cursor: pointer;">
          Dismiss
        </button>
      </div>
    `;
    document.body.appendChild(banner);
    
    // Auto-dismiss after 30 seconds
    setTimeout(() => {
      if (banner.parentNode) banner.remove();
    }, 30000);
  }
});
</script>
</body>
</html>
